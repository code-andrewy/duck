<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¨ Popcorn Hub üçø Beta</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ================= RESET ================= */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0d0d0d;
    color: #fff;
    overflow-x: hidden;
}

/* ================= HEADERS ================= */
h1 {
    text-align: center;
    font-size: 2.8rem;
    padding: 25px 0 5px;
}
h3 {
    text-align: center;
    font-weight: 400;
    color: #ccc;
    margin-top: 5px;
    font-size: 16px;
    font-style: italic;
}

/* ================= SEARCH ================= */
.search-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 20px;
    padding: 12px 20px;
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.08);
    border-radius: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    flex-wrap: wrap;
}

#searchInput {
    flex: 1 1 300px;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    outline: none;
    background: rgba(255, 255, 255, 0.06);
    color: #fff;
}
#searchInput:focus,
#searchInput:hover {
    background: rgba(255, 255, 255, 0.14);
}
#searchButton {
    padding: 12px 26px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: #fff;
    color: #111;
    transition: transform 0.2s;
}
#searchButton:hover { transform: scale(1.05); }

/* ================= GRID ================= */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
    padding: 0 20px 40px;
}

/* ================= CARDS ================= */
.movie-card, .cont-card {
    position: relative;
    overflow: hidden;
    border-radius: 14px;
    cursor: pointer;
    background: #111;
    transition: transform 0.2s, box-shadow 0.2s;
}
.movie-card:hover, .cont-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.5);
}
.movie-card img, .cont-card img {
    width: 100%;
    height: 320px;
    object-fit: cover;
    border-radius: 14px;
    transition: transform 0.3s ease;
}
.cont-card img { height: 250px; }
.movie-card:hover img, .cont-card:hover img { transform: scale(1.06); }

/* ================= PLAY OVERLAY ================= */
.overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: rgba(255,255,255,0.9);
    background: rgba(0,0,0,0.4);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    border-radius: 14px;
}
.movie-card:hover .overlay,
.cont-card:hover .overlay {
    opacity: 1;
    transform: scale(1.1);
}
.overlay i { transition: transform 0.2s ease; }
.overlay:hover i { transform: scale(1.2); }

/* ================= CARD TITLES ================= */
.movie-card .title {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 10px;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    text-align: center;
    font-weight: bold;
    font-size: 16px;
}

/* ================= REMOVE BUTTON ================= */
.cont-card .remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: #f44336;
    border: none;
    border-radius: 12px;
    padding: 5px 8px;
    color: #fff;
    cursor: pointer;
    display: none;
}
.cont-card:hover .remove-btn { display: block; }

/* ================= LOAD MORE ================= */
#loadMoreBtn {
    display: block;
    margin: 20px auto 40px;
    padding: 12px 30px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    background: #fff;
    color: #000;
    cursor: pointer;
    transition: transform 0.2s;
}
#loadMoreBtn:hover { transform: scale(1.05); }

/* ================= DETAIL SCREEN ================= */
#detailScreen {
    display: none;
    position: fixed;
    inset: 0;
    background: #111;
    z-index: 9999;
    overflow-y: auto;
    padding: 40px 20px;
    animation: fadeIn 0.4s ease;
}
#detailScreen .closeDetail {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 36px;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    z-index: 10001;
}
#detailScreen .banner img {
    width: 100%;
    max-height: 60vh;
    object-fit: cover;
    border-radius: 16px;
}
#detailScreen .info {
    max-width: 800px;
    margin: 20px auto;
    text-align: center;
}
#detailScreen h2 { font-size: 32px; }
#detailScreen .rating { color: #ffd700; margin-bottom: 15px; }
#detailScreen p { font-size: 18px; line-height: 1.5; color: #ccc; }

/* ================= DETAIL BUTTONS ================= */
#detailScreen .buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
}
#detailScreen .buttons button {
    padding: 14px 28px;
    font-size: 18px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s;
}
#watchBtn { background: #e50914; color: #fff; }
#watchBtn:hover { transform: scale(1.05); }
#trailerBtn { background: rgba(255,255,255,0.12); color: #fff; }
#trailerBtn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

/* ================= PLAYER ================= */
#playerContainer {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
}
#playerContainer iframe { width: 100%; height: 100%; border: none; }
#backBtn, #nextBtn {
    position: absolute;
    top: 20px;
    padding: 10px 16px;
    border-radius: 12px;
    background: rgba(0,0,0,0.85);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 18px;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 8px;
}
#backBtn { right: 20px; }
#nextBtn { left: 20px; }
#backBtn:hover, #nextBtn:hover { background: #000; transform: scale(1.05); }

/* ================= CONTINUE WATCHING ================= */
#continueWatchingSection {
    display: none;
    margin: 20px 0;
}
#continueWatchingSection h2 {
    margin-left: 20px;
    font-size: 1.4rem;
}
#continueWatching {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
    gap: 15px;
    padding: 0 20px;
}

/* ================= TOAST ================= */
#toastContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10002;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.toast {
    padding: 12px 20px;
    background: rgba(0,0,0,0.7);
    border-radius: 12px;
    font-size: 14px;
}

/* ================= ANIMATIONS ================= */
@keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

/* ================= RESPONSIVE ================= */
@media (max-width: 900px) { .movie-card img { height: 280px; } }
@media (max-width: 600px) { 
    .movie-card img { height: 240px; }
    #detailScreen h2 { font-size: 24px; }
    #detailScreen .buttons button { font-size: 16px; padding: 12px 24px; }
}
@media (max-width: 400px) {
    #searchInput { flex: 1 1 150px; }
    .grid { gap: 12px; }
    #continueWatching { grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); }
}
</style>
</head>
<body>

<h1>üé¨ Popcorn Hub üçø Beta</h1>
<h3>Mathematically proven to make your day better :)</h3>
<h3>How's your day going?</h3>

<div class="search-container">
  <input id="searchInput" placeholder=" What are you gonna watch today? üçø" />
  <button id="searchButton"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
</div>

<div id="continueWatchingSection">
  <h2 style="margin-left:18px"><i class="fa-solid fa-play-circle"></i> Continue Watching</h2>
  <div id="continueWatching"></div>
</div>

<div id="trending" class="grid"></div>
<button id="loadMoreBtn">load more results</button>

<!-- Detail screen -->
<div id="detailScreen">
  <button class="closeDetail"><i class="fa-solid fa-xmark"></i></button>
  <div class="banner"><img id="detailImage" src="" alt=""></div>
  <div class="info">
    <h2 id="detailTitle"></h2>
    <div class="rating" id="detailRating"></div>
    <p id="detailOverview"></p>

    <div class="detail-controls">
      <button id="watchBtn"><i class="fa-solid fa-play"></i> Watch Now</button>
      <button id="pickBtn" style="display:none;"><i class="fa-solid fa-list"></i> Pick Episode</button>
      <button id="trailerBtn"><i class="fa-solid fa-film"></i> Trailer</button>
    </div>
  </div>
</div>

<!-- Player -->
<div id="playerContainer">
  <button id="nextBtn"><i class="fa-solid fa-forward"></i> Next Episode</button>
  <button id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back</button>
  <iframe id="contentPlayer" sandbox=""></iframe>
</div>

<!-- Episode picker modal -->
<div id="episodePicker">
  <div class="picker-card">
    <div class="picker-head">
      <h3 id="pickerTitle">Pick Season & Episode</h3>
      <div>
        <select id="seasonSelect"></select>
      </div>
    </div>

    <div id="episodeRow" class="episode-row" aria-live="polite"></div>

    <div class="picker-actions">
      <button id="pickerCancel">Cancel</button>
      <button id="pickerPlay">Play Episode</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<script>
// ================= TMDB & CONFIG =================
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
const ITEMS_PER_PAGE = 15;
let trendingData = [], currentIndex = 0;
let currentTV = null, currentSeason = null, currentEpisode = null;

const $ = id => document.getElementById(id);
function toast(msg, ms=2800){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; $('toastContainer').appendChild(t); setTimeout(()=>t.remove(), ms); }
async function safeJson(r){ try{ if(!r||!r.ok) return null; return await r.json(); }catch(e){ return null; }
}
function mediaType(i){ return i._media_type || (i.title? 'movie':'tv'); }
const movieEmbed = id => `https://fmovies4u.com/embed/tmdb-movie-${id}`;
const tvEmbed = (id,s,e) => `https://fmovies4u.com/embed/tmdb-tv-${id}/${s}/${e}`;

/* ========== Trending / Cards ========== */
async function loadTrending(){
  try {
    const [mResp,tResp] = await Promise.all([
      fetch('https://api.themoviedb.org/3/trending/movie/week',{ headers:{ Authorization:`Bearer ${API_KEY}` } }),
      fetch('https://api.themoviedb.org/3/trending/tv/week',{ headers:{ Authorization:`Bearer ${API_KEY}` } })
    ]);
    const m = await safeJson(mResp) || { results: [] };
    const t = await safeJson(tResp) || { results: [] };
    trendingData = [...(m.results||[]).map(x=>({...x,_media_type:'movie'})), ...(t.results||[]).map(x=>({...x,_media_type:'tv'}))];
    trendingData.sort((a,b)=> (b.popularity||0)-(a.popularity||0));
    currentIndex = 0; $('trending').innerHTML=''; loadMore();
  } catch(e){ console.error(e); toast('Failed to load trending'); }
}
function createCard(item){
  const d = document.createElement('div'); d.className='movie-card';
  const img = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750';
  d.innerHTML = `<img src="${img}" alt=""><div class="title">${item.title||item.name}</div>`;
  d.onclick = ()=> openDetail(item);
  return d;
}
function loadMore(){
  const c = $('trending');
  const items = trendingData.slice(currentIndex, currentIndex + ITEMS_PER_PAGE);
  items.forEach(i=> c.appendChild(createCard(i)));
  currentIndex += items.length;
  $('loadMoreBtn').style.display = currentIndex >= trendingData.length ? 'none' : 'block';
}

/* ========== Search ========== */
async function searchContent(){
  const q = $('searchInput').value.trim();
  if(!q) return toast('Enter a search term');
  try {
    const [mResp,tResp] = await Promise.all([
      fetch(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(q)}&language=en-US`, { headers:{ Authorization:`Bearer ${API_KEY}` } }),
      fetch(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(q)}&language=en-US`,    { headers:{ Authorization:`Bearer ${API_KEY}` } })
    ]);
    const md = await safeJson(mResp) || { results: [] }, td = await safeJson(tResp) || { results: [] };
    trendingData = [...(md.results||[]).map(x=>({...x,_media_type:'movie'})), ...(td.results||[]).map(x=>({...x,_media_type:'tv'}))];
    currentIndex = 0; $('trending').innerHTML=''; if(!trendingData.length){ $('trending').innerHTML='<p style="padding:18px;color:#ccc">No results</p>'; $('loadMoreBtn').style.display='none'; return; } loadMore();
  } catch(e){ console.error(e); toast('Search failed'); }
}

/* ========== Episode Picker UI ========== */
const episodeModal = $('episodePicker');
const seasonSelect = $('seasonSelect');
const episodeRow = $('episodeRow');
let episodePickerResolve = null;

async function openEpisodePicker(tvId, preselect = null){
  // preselect = {season, episode} optional
  episodeModal.style.display = 'flex';
  seasonSelect.innerHTML = '';
  episodeRow.innerHTML = '';
  $('pickerTitle').textContent = 'Pick Season & Episode';

  const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
  const tvData = await safeJson(tvResp);
  if(!tvData){ toast('Failed to load show info'); episodeModal.style.display='none'; return null; }

  const seasons = (tvData.seasons || []).filter(s=>s.season_number>0);
  seasons.forEach(s => {
    const opt = document.createElement('option'); opt.value = s.season_number;
    opt.textContent = `Season ${s.season_number}${s.name ? ' ‚Äî '+s.name:''}`; seasonSelect.appendChild(opt);
  });

  const loadFor = async (snum, highlightEp=null) => {
    episodeRow.innerHTML = '';
    const resp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${snum}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sdata = await safeJson(resp);
    const eps = sdata?.episodes || [];
    if(!eps.length){ episodeRow.innerHTML = '<div style="color:#aaa;padding:8px">No episodes</div>'; return; }
    eps.forEach(ep=>{
      const btn = document.createElement('button');
      btn.className = 'episode-btn';
      btn.dataset.ep = ep.episode_number;
      btn.innerHTML = `<div class="ep-num">E${ep.episode_number}</div><span class="ep-title">${ep.name || 'Untitled'}</span>`;
      // mark watched if this is preselect
      if (highlightEp && Number(highlightEp) === Number(ep.episode_number)) {
        btn.classList.add('active', 'watched');
        setTimeout(()=> btn.scrollIntoView({behavior:'smooth', inline:'center'}), 60);
      }
      btn.onclick = () => {
        episodeRow.querySelectorAll('.episode-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      };
      episodeRow.appendChild(btn);
    });
  };

  // initial season selection
  if(preselect && preselect.season){
    const found = Array.from(seasonSelect.options).find(o=>Number(o.value)===Number(preselect.season));
    if(found) seasonSelect.value = found.value;
  }
  await loadFor(seasonSelect.value, preselect?.episode);

  seasonSelect.onchange = async () => { await loadFor(seasonSelect.value, preselect?.episode); };

  // return promise that resolves when play/cancel pressed
  return new Promise((resolve) => {
    episodePickerResolve = resolve;
    $('pickerCancel').onclick = () => { episodeModal.style.display='none'; episodePickerResolve = null; resolve(null); };
    $('pickerPlay').onclick = () => {
      const active = episodeRow.querySelector('.episode-btn.active');
      if(!active){ toast('Select an episode'); return; }
      const season = Number(seasonSelect.value), episode = Number(active.dataset.ep);
      episodeModal.style.display='none';
      episodePickerResolve = null;
      resolve({ season, episode });
    };
  });
}

/* ========== Detail / Watch logic ========== */
async function openDetail(item, progress=null){
  item._media_type = mediaType(item);
  $('detailScreen').style.display = 'flex'; document.body.style.overflow = 'hidden';
  $('detailImage').src = item.backdrop_path ? `https://image.tmdb.org/t/p/w780${item.backdrop_path}` : (item.poster_path?`https://image.tmdb.org/t/p/w500${item.poster_path}`:'');
  $('detailTitle').textContent = item.title || item.name || 'Untitled';
  $('detailOverview').textContent = item.overview || 'No description';
  $('detailRating').textContent = `‚≠ê ${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}`;

  // load saved progress for this show only
  if(item._media_type === 'tv'){
    const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
    const key = `${item.id}-tv`;
    if(progress && progress.season && progress.episode){ currentTV = item.id; currentSeason = Number(progress.season); currentEpisode = Number(progress.episode); }
    else if(saved[key]){ currentTV = item.id; currentSeason = Number(saved[key].season); currentEpisode = Number(saved[key].episode); }
    else { currentTV = currentSeason = currentEpisode = null; }
    $('pickBtn').style.display = 'inline-flex';
  } else {
    currentTV = currentSeason = currentEpisode = null;
    $('pickBtn').style.display = 'none';
  }

  const watchBtn = $('watchBtn');
  if(item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode) {
    watchBtn.textContent = `Resume S${currentSeason}¬∑E${currentEpisode}`;
  } else watchBtn.textContent = 'Watch Now';

  watchBtn.onclick = async () => {
    const iframe = $('contentPlayer');
    iframe.setAttribute('sandbox','allow-scripts allow-same-origin'); iframe.setAttribute('referrerpolicy','no-referrer');
    if(item._media_type === 'movie'){ iframe.src = movieEmbed(item.id); $('playerContainer').style.display='flex'; $('nextBtn').style.display='none'; saveContinue(item); }
    else {
      // if resume exists, play it; otherwise open picker
      if(currentTV === item.id && currentSeason && currentEpisode) {
        iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
        $('playerContainer').style.display='flex'; $('nextBtn').style.display='flex'; saveContinue(item);
      } else {
        const sel = await openEpisodePicker(item.id, null);
        if(!sel) return;
        currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
        iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
        $('playerContainer').style.display='flex'; $('nextBtn').style.display='flex'; saveContinue(item);
      }
    }
  };

  $('pickBtn').onclick = async () => {
    // open picker and preselect last watched if present
    const pre = (currentTV === item.id && currentSeason && currentEpisode) ? { season: currentSeason, episode: currentEpisode } : null;
    const sel = await openEpisodePicker(item.id, pre);
    if(!sel) return;
    currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
    // start playback immediately after picking
    const iframe = $('contentPlayer'); iframe.setAttribute('sandbox','allow-scripts allow-same-origin'); iframe.setAttribute('referrerpolicy','no-referrer');
    iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
    $('playerContainer').style.display='flex'; $('nextBtn').style.display='flex';
    saveContinue(item);
  };

  $('trailerBtn').onclick = async () => {
    try {
      const res = await fetch(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
      const data = await safeJson(res);
      const trailer = (data?.results||[]).find(v => v.site === 'YouTube' && v.type === 'Trailer');
      if(trailer) window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank', 'noopener,noreferrer');
      else toast('Trailer not available');
    } catch(e){ console.error(e); toast('Trailer fetch failed'); }
  };

  // check next visibility
  if(item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode){
    checkNextEpisode(item.id, currentSeason, currentEpisode).catch(()=> $('nextBtn').style.display='none');
  } else $('nextBtn').style.display='none';
}

/* ========== Continue watching render + edit ========== */
async function renderContinueWatching(){
  const section = $('continueWatchingSection'), container = $('continueWatching');
  container.innerHTML=''; const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
  const keys = Object.keys(saved).sort((a,b)=>(saved[b].timestamp||0)-(saved[a].timestamp||0));
  if(!keys.length){ section.style.display='none'; return; } section.style.display='block';
  const fetches = keys.map(k=> fetch(`https://api.themoviedb.org/3/${saved[k].type}/${saved[k].id}`, { headers:{ Authorization:`Bearer ${API_KEY}` } }).then(r=>safeJson(r)).then(d=>({ key:k, meta:saved[k], data:d })).catch(e=>({ key:k, meta:saved[k], data:null })));
  const results = await Promise.all(fetches);
  results.forEach(res=>{
    const k=res.key, s=res.meta, data=res.data;
    const card = document.createElement('div'); card.className='cont-card'; card.style.position='relative';
    if(!data){ card.innerHTML = `<div style="background:#333;height:240px;"></div>`; container.appendChild(card); return; }
    const img = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : 'https://via.placeholder.com/500x750';
    const label = (s.type==='tv' && s.season && s.episode) ? `S${s.season}¬∑E${s.episode}` : '';
    card.innerHTML = `<img src="${img}" alt=""><div style="position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,0.6);padding:4px 8px;border-radius:6px;font-size:12px;color:#fff;">${label}</div>
      <div style="position:absolute;right:6px;top:6px;display:flex;gap:6px;">
        <button class="edit-btn" style="background:#222;color:#fff;border-radius:6px;padding:6px;">‚úé</button>
        <button class="rm-btn" style="background:#f44336;color:#fff;border-radius:6px;padding:6px;">üóë</button>
      </div>`;
    // click to open detail with progress
    card.addEventListener('click', (e)=>{ if(e.target.closest('.edit-btn')||e.target.closest('.rm-btn')) return; openDetail(data, { season: s.season, episode: s.episode }); });
    // edit
    card.querySelector('.edit-btn').addEventListener('click', async (e)=>{
      e.stopPropagation();
      const sel = await openEpisodePicker(s.id, { season: s.season, episode: s.episode });
      if(!sel) return;
      const store = JSON.parse(localStorage.getItem('continueWatching')||'{}');
      store[k].season = sel.season; store[k].episode = sel.episode; store[k].timestamp = Date.now();
      localStorage.setItem('continueWatching', JSON.stringify(store));
      toast('Updated continue watching');
      renderContinueWatching();
    });
    // remove
    card.querySelector('.rm-btn').addEventListener('click', (e)=>{ e.stopPropagation(); const store = JSON.parse(localStorage.getItem('continueWatching')||'{}'); delete store[k]; localStorage.setItem('continueWatching', JSON.stringify(store)); renderContinueWatching(); });
    container.appendChild(card);
  });
}

/* ========== Save continue helper ========== */
function saveContinue(item){
  const type = item._media_type || mediaType(item);
  const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
  saved[`${item.id}-${type}`] = { id: item.id, type, season: type==='tv'? Number(currentSeason): null, episode: type==='tv'? Number(currentEpisode): null, timestamp: Date.now() };
  localStorage.setItem('continueWatching', JSON.stringify(saved));
  renderContinueWatching();
}

/* ========== Next episode logic ========== */
async function checkNextEpisode(tvId, season, episode){
  try {
    season = Number(season); episode = Number(episode);
    const sResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sData = await safeJson(sResp);
    const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const tvData = await safeJson(tvResp);
    const epsInSeason = sData?.episodes?.length || 0;
    let hasNext = (episode < epsInSeason);
    if(!hasNext){
      const maxSeason = tvData?.number_of_seasons || (tvData.seasons ? Math.max(...tvData.seasons.map(s=>s.season_number||0)) : 0);
      for(let s=season+1; s<=maxSeason; s++){
        try{
          const resp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${s}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
          const sData2 = await safeJson(resp);
          if(sData2 && (sData2.episodes||[]).length>0){ hasNext = true; break; }
        }catch(e){ continue; }
      }
    }
    if($('nextBtn')) $('nextBtn').style.display = 'flex';
    return hasNext;
  } catch(e){ console.error(e); if($('nextBtn')) $('nextBtn').style.display='none'; return false; }
}

$('nextBtn').onclick = async ()=>{
  try{
    if(!currentTV) return;
    currentSeason = Number(currentSeason); currentEpisode = Number(currentEpisode);
    const sResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${currentSeason}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sData = await safeJson(sResp);
    const total = sData?.episodes?.length || 0;
    currentEpisode++;
    if(currentEpisode > total){
      // next season
      const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
      const tvData = await safeJson(tvResp);
      let found=false; const maxSeason = tvData?.number_of_seasons || 0;
      for(let s=currentSeason+1; s<=maxSeason; s++){
        try{
          const nResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${s}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
          const nData = await safeJson(nResp);
          if(nData && (nData.episodes||[]).length>0){ currentSeason=s; currentEpisode=1; found=true; break; }
        }catch(e){ continue; }
      }
      if(!found){ currentSeason=1; currentEpisode=1; }
    }
    $('contentPlayer').setAttribute('sandbox','allow-scripts allow-same-origin');
    $('contentPlayer').src = tvEmbed(currentTV, currentSeason, currentEpisode);
    // save
    const store = JSON.parse(localStorage.getItem('continueWatching')||'{}');
    store[`${currentTV}-tv`] = { id: currentTV, type:'tv', season: currentSeason, episode: currentEpisode, timestamp: Date.now() };
    localStorage.setItem('continueWatching', JSON.stringify(store));
    renderContinueWatching();
    await checkNextEpisode(currentTV, currentSeason, currentEpisode);
  }catch(e){ console.error(e); toast('Failed to load next'); }
};

/* ========== Trailer ========== */
async function openTrailer(item){ try{ const r = await fetch(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`, { headers:{ Authorization:`Bearer ${API_KEY}` } }); const d = await safeJson(r); const t = (d?.results||[]).find(v=>v.site==='YouTube'&&v.type==='Trailer'); if(t) window.open(`https://www.youtube.com/watch?v=${t.key}`, '_blank','noopener'); else toast('Trailer not available'); }catch(e){console.error(e); toast('Trailer failed'); }}

/* ========== Close / Back UI ========== */
$('backBtn').onclick = ()=>{ $('playerContainer').style.display='none'; $('contentPlayer').src=''; currentTV=currentSeason=currentEpisode=null; $('nextBtn').style.display='none'; };
document.querySelector('.closeDetail').onclick = ()=>{ $('detailScreen').style.display='none'; document.body.style.overflow='auto'; };

/* ========== Init ========== */
window.addEventListener('DOMContentLoaded', ()=>{
  $('loadMoreBtn').addEventListener('click', loadMore);
  $('searchButton').addEventListener('click', searchContent);
  $('searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') searchContent(); });
  loadTrending(); renderContinueWatching();
});
</script>
</body>
</html>