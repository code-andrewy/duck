<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üé¨Popcorn Hub üçø</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
  color: #e6e6e6;
  margin: 0;
  padding: 20px;
}

h1,h2 { text-align:center; margin-bottom:20px; }
h1 { font-size:2.5rem; }
h2 { font-size:2rem; }

.search-container { display:flex; justify-content:center; gap:12px; margin-bottom:30px; flex-wrap:wrap; }
input#searchInput { width:60%; padding:14px 20px; font-size:16px; border-radius:25px; border:1px solid rgba(255,255,255,0.15); outline:none; background: rgba(255,255,255,0.05); color:#f0f0f0; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: all 0.3s ease; }
input#searchInput:focus { width:70%; background: rgba(255,255,255,0.08); box-shadow:0 6px 20px rgba(0,0,0,0.5); }

button, .show-more, .trailer-btn { padding:12px 24px; font-size:16px; border-radius:25px; border:none; cursor:pointer; font-weight:600; transition: all 0.25s ease; background:#f5f5f5; color:#111; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
button:hover, .show-more:hover, .trailer-btn:hover { transform: translateY(-2px) scale(1.04); box-shadow:0 8px 20px rgba(0,0,0,0.25); }

#continueWatching, #trending, #results { margin-top:30px; display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:24px; }

.movie-card { background: rgba(255, 255, 255, 0.06); border-radius:18px; padding:18px; text-align:center; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.35); backdrop-filter: blur(12px); transition: transform 0.3s ease, box-shadow 0.3s ease; position:relative; }
.movie-card:hover { transform: translateY(-8px) scale(1.05); box-shadow:0 12px 28px rgba(0,0,0,0.5); }
.movie-card img { width:100%; border-radius:14px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
.movie-title { margin-top:12px; font-size:18px; font-weight:700; color:#fff; }
.movie-overview { margin-top:8px; font-size:14px; color:#bbb; line-height:1.5; }

#playerContainer { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999; background-color:#000; }
iframe { width:100%; height:100%; border:none; }

#playerRating {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  font-weight: 600;
  font-size: 16px;
  border-radius: 20px;
  text-align: center;
  z-index: 1000;
}

button#backButton, #nextEpisodeButton {
  position: absolute;
  top: 20px;
  font-size: 16px;
  padding: 12px 24px;
  border-radius: 25px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  background: #f5f5f5;
  color: #111;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: opacity 0.8s ease;
  opacity: 1;
  z-index: 1000;
}
button#backButton { right: 20px; }
#nextEpisodeButton { right: 220px; display: none; }

</style>
</head>
<body>

<h1>üé¨Popcorn Hub üçøüé•</h1>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Enter movie, TV show, or anime..." />
  <button id="searchButton">Search</button>
</div>

<div id="homeContent">
  <div id="continueWatchingSection" style="display:none;">
    <h2>‚èØÔ∏è Continue Watching</h2>
    <div id="continueWatching"></div>
  </div>
  <h2>üî• Trending</h2>
  <div id="trending"></div>
</div>

<div id="results"></div>

<div id="playerContainer">
  <button id="backButton">üîô Back to Search</button>
  <button id="nextEpisodeButton">‚è≠Ô∏è Next Episode</button>
  <div id="playerRating">No rating</div>
  <iframe id="contentPlayer"></iframe>
</div>

<script>
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
let trendingData = [], resultsData = [], trendingIndex = 0, resultsIndex = 0;
const ITEMS_PER_PAGE = 15;

const backBtn = document.getElementById('backButton');
const nextBtn = document.getElementById('nextEpisodeButton');
const ratingDiv = document.getElementById('playerRating');
const playerContainer = document.getElementById('playerContainer');
const contentPlayer = document.getElementById('contentPlayer');

let fadeTimeout;

// FADE BUTTONS
function fadeButtonsOut() {
    fadeTimeout = setTimeout(() => {
        backBtn.style.opacity = 0;
        nextBtn.style.opacity = 0;
    }, 2000);
}

function fadeButtonsIn() {
    clearTimeout(fadeTimeout);
    backBtn.style.opacity = 1;
    nextBtn.style.opacity = 1;
    fadeButtonsOut();
}

playerContainer.addEventListener('mousemove', fadeButtonsIn);

// SHOW PLAYER RATING
async function showPlayerRating(tmdbId, type) {
    try {
        if(type === 'movie') {
            const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/release_dates`, { headers:{Authorization:`Bearer ${API_KEY}`}});
            const data = await res.json();
            const us = data.results.find(x=>x.iso_3166_1==='US');
            ratingDiv.textContent = us?.release_dates[0]?.certification || 'N/A';
        } else if(type==='tv') {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/content_ratings`, { headers:{Authorization:`Bearer ${API_KEY}`}});
            const data = await res.json();
            const us = data.results.find(x=>x.iso_3166_1==='US');
            ratingDiv.textContent = us?.rating || 'N/A';
        } else {
            ratingDiv.textContent = 'N/A';
        }
    } catch(e){
        ratingDiv.textContent = 'N/A';
        console.error(e);
    }
}

// RENDER ITEMS (MOVIES & TV)
function renderItems(data, containerId, index){
    const container = document.getElementById(containerId);
    if(!container) return index;
    const nextBatch = data.slice(index, index + ITEMS_PER_PAGE);

    nextBatch.forEach(item => {
        if(!item.poster_path && !item.backdrop_path) return;

        const isMovie = !!item.title;
        const title = isMovie ? item.title : item.name || '';
        const shortOverview = item.overview ? item.overview.substring(0,100)+'...' : 'No description available.';
        const fullOverview = item.overview || 'No description available.';
        const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w300${item.poster_path}` : (item.backdrop_path ? `https://image.tmdb.org/t/p/w300${item.backdrop_path}` : '');

        const card = document.createElement('div');
        card.className = 'movie-card';
        card.innerHTML = `
            <img src="${posterPath}" alt="${title}">
            <div class="movie-title">${title}</div>
            <div class="movie-overview">${shortOverview}</div>
            <button class="trailer-btn">üé¨ Trailer</button>
        `;

        const overviewDiv = card.querySelector('.movie-overview');
        card.addEventListener('mouseenter', ()=> overviewDiv.textContent = fullOverview);
        card.addEventListener('mouseleave', ()=> overviewDiv.textContent = shortOverview);

        card.addEventListener('click', async () => {
            if(isMovie){
                showPlayer(item.id,'movie');
            } else {
                const {season, episode} = await promptValidSeasonEpisode(item.id);
                if(season && episode) showPlayer(item.id,'tv', season, episode);
            }
        });

        card.querySelector('.trailer-btn').addEventListener('click', async e=>{
            e.stopPropagation();
            try{
                const res = await fetch(`https://api.themoviedb.org/3/${isMovie?'movie':'tv'}/${item.id}/videos?language=en-US`, {headers:{Authorization:`Bearer ${API_KEY}`}});
                const data = await res.json();
                const trailer = data.results.find(v=>v.type==='Trailer' && v.site==='YouTube');
                if(trailer) window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
                else alert('Trailer not available.');
            } catch(err){ console.error(err); alert('Failed to load trailer.'); }
        });

        container.appendChild(card);
    });

    return index + ITEMS_PER_PAGE;
}

// SHOW MORE
function showMore(type){
    if(type==='trending'){
        trendingIndex = renderItems(trendingData,'trending',trendingIndex);
    } else if(type==='results'){
        resultsIndex = renderItems(resultsData,'results',resultsIndex);
    }
}

// LOAD TRENDING
async function loadTrending(){
    const trendingContainer = document.getElementById('trending');
    if(!trendingContainer) return;
    trendingContainer.innerHTML='<div style="color:#fff;text-align:center;">Loading...</div>';
    try{
        const [movieTrending,tvTrending] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/trending/movie/week`,{headers:{Authorization:`Bearer ${API_KEY}`}}),
            fetch(`https://api.themoviedb.org/3/trending/tv/week`,{headers:{Authorization:`Bearer ${API_KEY}`}})
        ]);
        const movieData = await movieTrending.json();
        const tvData = await tvTrending.json();
        trendingData = [...movieData.results, ...tvData.results];
        trendingData.sort((a,b)=>(b.popularity||0)-(a.popularity||0));
        trendingIndex=0;
        trendingContainer.innerHTML='';
        showMore('trending');
    } catch(error){
        trendingContainer.innerHTML='<p>Failed to load trending content (check api key) </p>';
        console.error(error);
    }
}

// SEARCH
async function searchContent(){
    const query = document.getElementById('searchInput')?.value.trim();
    if(!query) return alert("Please enter a movie or TV show name");

    const resultsDiv = document.getElementById('results');
    const homeContent = document.getElementById('homeContent');
    resultsDiv.style.display='grid';
    homeContent.style.display='none';
    resultsDiv.innerHTML='<div style="color:#fff;text-align:center;">Searching...</div>';

    try{
        const [movieResponse,tvResponse] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(query)}`,{headers:{Authorization:`Bearer ${API_KEY}`}}),
            fetch(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(query)}`,{headers:{Authorization:`Bearer ${API_KEY}`}})
        ]);
        const movieData = await movieResponse.json();
        const tvData = await tvResponse.json();

        resultsData = [...movieData.results, ...tvData.results];
        resultsIndex = 0;
        resultsDiv.innerHTML = '';
        showMore('results');
    } catch(error){
        resultsDiv.innerHTML='<p>Something went wrong. Please try again later!</p>';
        console.error(error);
    }
}

// PROMPT SEASON/EPISODE
async function promptValidSeasonEpisode(tmdbId){
    try{
        const tvRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        const tvData = await tvRes.json();
        const totalSeasons = tvData.number_of_seasons;
        let season;
        do {
            const input = prompt(`Enter season (1-${totalSeasons}):`);
            if(input===null) return {};
            season = parseInt(input);
        } while(!Number.isInteger(season) || season<1 || season>totalSeasons);

        const seasonRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${season}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        const seasonData = await seasonRes.json();
        const totalEpisodes = seasonData.episodes.length;

        let episode;
        do {
            const input = prompt(`Enter episode (1-${totalEpisodes}):`);
            if(input===null) return {};
            episode = parseInt(input);
        } while(!Number.isInteger(episode) || episode<1 || episode>totalEpisodes);

        return {season, episode};
    } catch(err){
        console.error(err);
        alert('Failed to fetch TV show data.');
        return {};
    }
}

// SHOW PLAYER
function showPlayer(tmdbId, type, season=null, episode=null){
    playerContainer.style.display='block';
    fadeButtonsOut();
    showPlayerRating(tmdbId,type);

    if(type==='movie'){
        nextBtn.style.display='none';
        contentPlayer.src=`https://vidfast.pro/movie/${tmdbId}`;
    } else if(type==='tv'){
        if(!season||!episode) return;
        nextBtn.style.display='block';
        nextBtn.onclick=()=>nextEpisode(tmdbId,season,episode);
        contentPlayer.src=`https://vidfast.pro/tv/${tmdbId}/${season}/${episode}?autoPlay=true`;
    }
}

// NEXT EPISODE
async function nextEpisode(tmdbId, currentSeason, currentEpisode){
    try{
        const tvRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        const tvData = await tvRes.json();
        const totalSeasons = tvData.number_of_seasons;

        const seasonRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${currentSeason}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        const seasonData = await seasonRes.json();
        const totalEpisodes = seasonData.episodes.length;

        let nextSeason = currentSeason;
        let nextEpisodeNum = currentEpisode+1;

        if(nextEpisodeNum>totalEpisodes){
            nextSeason++;
            nextEpisodeNum=1;
        }
        if(nextSeason>totalSeasons){
            return alert("No more episodes available!");
        }

        showPlayer(tmdbId,'tv',nextSeason,nextEpisodeNum);
    } catch(err){
        console.error(err);
        alert("Failed to load next episode.");
    }
}

// BACK BUTTON
backBtn.addEventListener('click', ()=>{
    playerContainer.style.display='none';
    contentPlayer.src='';
});

// INIT
window.onload=()=>loadTrending();
document.getElementById('searchButton')?.addEventListener('click',searchContent);
document.getElementById('searchInput')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchContent(); });
</script>
</body>
</html>
