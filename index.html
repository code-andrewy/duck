<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üé¨ Popcorn Hub üçø Beta</title>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-pZTSs1..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* --- Body & Fonts --- */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; 
    padding: 0;
    background: #0d0d0d;
    color: #fff;
    overflow-x: hidden;
}

/* --- Header --- */
h1 {
    text-align: center;
    padding: 20px 0 5px 0;
    font-size: 2.5rem;
}
h3 {
    text-align: center;
    font-weight: 400;
    color: #ccc;
    margin-top: -5px;
    font-size: 16px;
    font-style: italic;
}

/* --- Search Bar --- */
.search-container {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 30px;
    padding: 12px 20px;
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.08);
    border-radius: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    flex-wrap: wrap;
    transition: all 0.3s ease;
}
#searchInput {
    flex: 1 1 300px;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.05);
    color: #fff;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
#searchInput:focus, 
#searchInput:hover {
    flex: 1 1 450px; /* Expands the input */
    background: rgba(255,255,255,0.12);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    transform: scale(1.02);
}

/* Optional pulsing effect while focused */
@keyframes pulse {
    0% { box-shadow: 0 0 8px rgba(255,255,255,0.2); }
    50% { box-shadow: 0 0 16px rgba(255,255,255,0.4); }
    100% { box-shadow: 0 0 8px rgba(255,255,255,0.2); }
}
#searchInput:focus {
    animation: pulse 1.5s infinite;
}

#searchButton {
    padding: 12px 24px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: #f5f5f5;
    color: #111;
    transition: all 0.3s;
}
#searchButton:hover {
    transform: scale(1.05);
}

/* --- Grids --- */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
    padding: 0 20px 40px;
}

/* --- Movie/TV Cards --- */
.movie-card, .cont-card {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}
.movie-card img, .cont-card img {
    width: 100%;
    height: 330px;
    object-fit: cover;
    transition: transform 0.3s;
}
.cont-card img {
    height: 250px;
}
.movie-card:hover img, .cont-card:hover img {
    transform: scale(1.05);
}
.movie-card .overlay {
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 50px;
    color: #fff;
}
.movie-card:hover .overlay { opacity: 1; }
.movie-card .title {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: linear-gradient(0deg, rgba(0,0,0,0.9), transparent);
    color: #fff;
    padding: 10px;
    font-weight: bold;
    text-align: center;
}
.cont-card .remove-btn {
    position: absolute;
    top: 5px; right: 5px;
    background: #f44336;
    border: none;
    border-radius: 12px;
    padding: 5px 8px;
    color: #fff;
    cursor: pointer;
    display: none;
}
.cont-card:hover .remove-btn { display: block; }

/* --- Buttons --- */
#loadMoreBtn {
    display: block;
    margin: 20px auto 40px;
    padding: 12px 30px;
    font-size: 16px;
    border: none;
    border-radius: 25px;
    background: #FFFFFF;
    color: #000000;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}
#loadMoreBtn:hover { transform: scale(1.05); }

/* --- Detail Screen --- */
#detailScreen {
    display: none;
    position: fixed;
    top:0; left:0;
    width: 100vw;
    height: 100vh;
    background: #111;
    z-index: 9999;
    overflow-y: auto;
    padding: 40px 20px;
    box-sizing: border-box;
    color: #fff;
    animation: fadeIn 0.5s;
    flex-direction: column;
    align-items: center;
}
#detailScreen .closeDetail {
    position: fixed;
    top: 20px; right: 20px;
    font-size: 36px;
    background: none; border: none;
    color: #fff; cursor: pointer;
    z-index: 10001;
    transition: all 0.3s;
}
#detailScreen .closeDetail:hover { color: #e50914; transform: scale(1.2); }
#detailScreen .banner img { width: 100%; max-height: 60vh; object-fit: cover; border-radius: 16px; }
#detailScreen .info { max-width: 800px; margin: 20px auto; text-align: center; }
#detailScreen h2 { margin: 10px 0; font-size: 32px; }
#detailScreen .rating { margin-bottom: 15px; font-weight: bold; color: #ffd700; }
#detailScreen p { font-size: 18px; line-height: 1.5; color: #ccc; }
#detailScreen .buttons {
    display: none;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
}
#detailScreen .buttons button {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}
#watchBtn { background: #e50914; color: #fff; }
#watchBtn:hover { transform: scale(1.05); }
#trailerBtn { background: rgba(255,255,255,0.1); color: #fff; }
#trailerBtn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

/* --- Fullscreen Player --- */
#playerContainer {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 10000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#playerContainer iframe {
    width: 100%;
    height: 100%;
    border: none;
}
#backBtn, #nextBtn {
    position: absolute;
    top: 20px;
    z-index: 10001;
    background: rgba(0,0,0,0.8);
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}
#backBtn { right: 20px; }
#nextBtn { left: 20px; }
#backBtn:hover, #nextBtn:hover { background: rgba(0,0,0,1); transform: scale(1.05); }

/* --- Continue Watching Section --- */
#continueWatchingSection { display: none; margin: 20px 0; }
#continueWatchingSection h2 { margin-left: 20px; font-size: 1.4rem; }
#continueWatching {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
    padding: 0 20px;
}

/* --- Animations --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

/* --- Toast --- */
#toastContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.toast {
    padding: 12px 20px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border-radius: 12px;
    min-width: 200px;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: fadeIn 0.4s ease;
}
</style>
</head>
<body>

<h1>üé¨ Popcorn Hub üçø Beta</h1>
<h3>Mathematically proven to make your day better :)</h3>
<h3> How's you're day going?</h3>

<div class="search-container">
  <input type="text" id="searchInput" placeholder=" What are your gonna watch today? üçø">
  <button id="searchButton" onclick="searchContent()"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
</div>

<!-- Continue Watching -->
<div id="continueWatchingSection">
  <i class="fa-solid fa-play-circle text-blue-500"></i>
  Continue Watching
</h2>
  <div id="continueWatching"></div>
</div>

<!-- Trending -->
<div id="trending" class="grid"></div>
<button id="loadMoreBtn" onclick="loadMore()">load more results</button>

<!-- Detail Screen -->
<div id="detailScreen">
  <button class="closeDetail"><i class="fa-solid fa-xmark"></i></button>
  <div class="banner"><img id="detailImage" src="" alt=""></div>
  <div class="info">
    <h2 id="detailTitle"></h2>
    <div class="rating" id="detailRating"></div>
    <p id="detailOverview"></p>
    <div class="buttons">
      <button id="watchBtn"><i class="fa-solid fa-play"></i> Watch Now</button>
      <button id="trailerBtn"><i class="fa-solid fa-film"></i> Trailer</button>
    </div>
  </div>
</div>

<!-- Fullscreen Player -->
<div id="playerContainer">
  <button id="nextBtn"><i class="fa-solid fa-forward"></i> Next Episode</button>
  <button id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back</button>
  <iframe id="contentPlayer" src=""></iframe>
</div>

<div id="toastContainer"></div>

<script>
// ================= TMDB & CONFIG =================
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
const ITEMS_PER_PAGE = 15;

// ================= State =================
let trendingData = [];
let currentIndex = 0;
let currentTV = null, currentSeason = null, currentEpisode = null;

// ================= Utilities =================
const $ = id => document.getElementById(id);
function safeGet(id){ return document.getElementById(id) || null; }

function toast(msg, ms = 3000){
  const c = safeGet('toastContainer');
  if(!c) return console.warn('toast container missing:', msg);
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(()=> { if(c.contains(el)) el.remove(); }, ms);
}

async function safeJson(resp){
  try {
    if(!resp) return null;
    if(!resp.ok) return null;
    return await resp.json();
  } catch(e){
    console.error('safeJson error', e);
    return null;
  }
}

function fetchAuth(url, opts = {}){
  opts.headers = Object.assign({}, opts.headers || {}, { Authorization: `Bearer ${API_KEY}` });
  return fetch(url, opts);
}

function mediaType(item){ return item? (item._media_type || (item.title ? 'movie' : 'tv')) : 'movie'; }

// ================= Embeds (safer sandbox) =================
// Use a restrictive sandbox. If an embed needs more it may break, but this is safer.
function setPlayerSrc(src){
  const iframe = safeGet('contentPlayer');
  if(!iframe) return toast('Player not found');
  // conservative sandbox: allow-scripts only; remove allow-popups/allow-top-navigation
  iframe.setAttribute('sandbox','allow-scripts');
  // keep referrer policy minimal
  iframe.setAttribute('referrerpolicy','no-referrer');
  iframe.src = src;
}

// ================= Trending / Cards =================
async function loadTrending(){
  try {
    const [mResp, tResp] = await Promise.all([
      fetchAuth('https://api.themoviedb.org/3/trending/movie/week'),
      fetchAuth('https://api.themoviedb.org/3/trending/tv/week')
    ]);
    const movies = await safeJson(mResp) || { results: [] };
    const tvs = await safeJson(tResp) || { results: [] };

    trendingData = [
      ...(movies.results || []).map(x => ({ ...x, _media_type: 'movie' })),
      ...(tvs.results || []).map(x => ({ ...x, _media_type: 'tv' }))
    ];
    trendingData.sort((a,b) => (b.popularity || 0) - (a.popularity || 0));
    currentIndex = 0;

    const grid = safeGet('trending');
    if(grid) grid.innerHTML = '';
    if(trendingData.length === 0){
      toast('No trending content found');
      const btn = safeGet('loadMoreBtn'); if(btn) btn.style.display = 'none';
      return;
    }
    loadMore();
  } catch(e){
    console.error('loadTrending', e);
    toast('Failed to load trending');
  }
}

function createCard(item){
  if(!item) return document.createElement('div');
  if(!item._media_type) item._media_type = mediaType(item);
  const div = document.createElement('div');
  div.className = 'movie-card';
  div.dataset.id = item.id;
  div.dataset.type = item._media_type;

  const title = item.title || item.name || 'Untitled';
  const img = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';

  div.innerHTML = `
    <img src="${img}" alt="${title.replace(/"/g,'')}" loading="lazy">
    <div class="title">${title}</div>
    <div class="overlay" aria-hidden="true"><i class="fa-solid fa-play"></i></div>
  `;

  div.addEventListener('click', () => openDetail(item));
  return div;
}

function loadMore(){
  const container = safeGet('trending');
  const btn = safeGet('loadMoreBtn');
  if(!container) return console.warn('trending container missing');
  if(!trendingData || trendingData.length === 0){
    container.innerHTML = '<p style="color:#ccc;padding:20px">No results to display.</p>';
    if(btn) btn.style.display = 'none';
    return;
  }
  const next = trendingData.slice(currentIndex, currentIndex + ITEMS_PER_PAGE);
  next.forEach(i => container.appendChild(createCard(i)));
  currentIndex += next.length;
  if(btn) btn.style.display = (currentIndex >= trendingData.length) ? 'none' : 'block';
}

// ================= Search =================
async function searchContent(){
  const q = (safeGet('searchInput') && safeGet('searchInput').value || '').trim();
  if(!q) return toast('Enter a search term');
  try {
    const [mResp, tResp] = await Promise.all([
      fetchAuth(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(q)}&language=en-US`),
      fetchAuth(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(q)}&language=en-US`)
    ]);
    const md = await safeJson(mResp) || { results: [] };
    const td = await safeJson(tResp) || { results: [] };
    trendingData = [
      ...(md.results || []).map(x => ({ ...x, _media_type: 'movie' })),
      ...(td.results || []).map(x => ({ ...x, _media_type: 'tv' }))
    ];
    currentIndex = 0;
    const grid = safeGet('trending'); if(grid) grid.innerHTML = '';
    const btn = safeGet('loadMoreBtn');
    if(!trendingData.length){
      if(grid) grid.innerHTML = '<p style="padding:20px;color:#ccc">No results</p>';
      if(btn) btn.style.display = 'none';
      return;
    }
    loadMore();
  } catch(e){
    console.error('searchContent', e);
    toast('Search failed');
  }
}

// ================= Episode Picker (modal primary, prompt fallback) =================
async function selectSeasonEpisodePrompt(tvId){
  // prompt-based fallback (keeps behavior like older version but safer)
  try {
    const resp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}?language=en-US`);
    const tv = await safeJson(resp);
    if(!tv) { toast('Failed to fetch show info'); return null; }
    const totalSeasons = tv.number_of_seasons || 1;
    let season;
    do {
      const v = prompt(`Enter season (1-${totalSeasons}):`);
      if(v === null) return null;
      season = parseInt(v);
    } while(!season || season < 1 || season > totalSeasons);

    const sResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}?language=en-US`);
    const sData = await safeJson(sResp);
    const totalEpisodes = (sData?.episodes?.length) || 1;
    let episode;
    do {
      const v = prompt(`Enter episode (1-${totalEpisodes}):`);
      if(v === null) return null;
      episode = parseInt(v);
    } while(!episode || episode < 1 || episode > totalEpisodes);

    return { season, episode };
  } catch(e){
    console.error('selectSeasonEpisodePrompt', e);
    toast('Failed to get season/episode info');
    return null;
  }
}

function pickerElements(){
  // return nulls if not present; openEpisodePicker will fallback
  return {
    modal: safeGet('episodePicker'),
    seasonSelect: safeGet('seasonSelect'),
    episodeRow: safeGet('episodeRow'),
    pickerTitle: safeGet('pickerTitle'),
    pickerCancel: safeGet('pickerCancel'),
    pickerPlay: safeGet('pickerPlay')
  };
}

async function openEpisodePicker(tvId, preselect = null){
  const els = pickerElements();
  if(!els.modal || !els.seasonSelect || !els.episodeRow || !els.pickerCancel || !els.pickerPlay){
    // fallback to prompt-based picker (safer than failing silently)
    return await selectSeasonEpisodePrompt(tvId);
  }

  const { modal, seasonSelect, episodeRow, pickerTitle, pickerCancel, pickerPlay } = els;
  modal.style.display = 'flex';
  pickerTitle && (pickerTitle.textContent = 'Pick Season & Episode');
  seasonSelect.innerHTML = '';
  episodeRow.innerHTML = '';

  // load show meta
  const tvResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}`);
  const tvData = await safeJson(tvResp);
  if(!tvData){
    toast('Failed to load show info'); modal.style.display='none'; return null;
  }

  const seasons = (tvData.seasons || []).filter(s => typeof s.season_number === 'number' && s.season_number > 0);
  if(seasons.length === 0){
    // create a single default season
    const opt = document.createElement('option'); opt.value = 1; opt.textContent = 'Season 1'; seasonSelect.appendChild(opt);
  } else {
    seasons.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.season_number;
      opt.textContent = `Season ${s.season_number}${s.name ? ' ‚Äî ' + s.name : ''}`;
      seasonSelect.appendChild(opt);
    });
  }

  // helper to load episodes
  let activeListeners = [];
  async function loadEpisodesFor(seasonNumber, highlightEpisode = null){
    // cleanup previous listeners (none necessary here)
    episodeRow.innerHTML = '';
    try {
      const sResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?language=en-US`);
      const sData = await safeJson(sResp);
      const eps = sData?.episodes || [];
      if(eps.length === 0){
        episodeRow.innerHTML = '<div style="color:#aaa;padding:8px">No episodes</div>';
        return;
      }
      eps.forEach(ep => {
        const btn = document.createElement('button');
        btn.className = 'episode-btn';
        btn.type = 'button';
        btn.dataset.ep = ep.episode_number;
        btn.innerHTML = `<div class="ep-num">E${ep.episode_number}</div><span class="ep-title">${ep.name || 'Untitled'}</span>`;
        btn.addEventListener('click', () => {
          episodeRow.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
        if(highlightEpisode && Number(highlightEpisode) === Number(ep.episode_number)){
          btn.classList.add('active','watched');
          setTimeout(()=> btn.scrollIntoView({behavior:'smooth', inline:'center'}), 30);
        }
        episodeRow.appendChild(btn);
      });
    } catch(e){
      console.error('loadEpisodesFor', e);
      episodeRow.innerHTML = '<div style="color:#aaa;padding:8px">Failed to load episodes</div>';
    }
  }

  // pre-select season if passed
  if(preselect && preselect.season){
    const found = Array.from(seasonSelect.options).find(o => Number(o.value) === Number(preselect.season));
    if(found) seasonSelect.value = found.value;
  }

  // initial load
  await loadEpisodesFor(seasonSelect.value, preselect?.episode);

  // wire change
  const onSeasonChange = async () => { await loadEpisodesFor(seasonSelect.value, preselect?.episode); };
  seasonSelect.addEventListener('change', onSeasonChange);

  // return promise resolved on play or cancel
  return new Promise((resolve) => {
    function cleanup(){
      seasonSelect.removeEventListener('change', onSeasonChange);
      pickerCancel.removeEventListener('click', onCancel);
      pickerPlay.removeEventListener('click', onPlay);
    }
    function onCancel(){
      modal.style.display = 'none';
      cleanup();
      resolve(null);
    }
    function onPlay(){
      const active = episodeRow.querySelector('button.active');
      if(!active){ toast('Select an episode'); return; }
      const season = Number(seasonSelect.value);
      const episode = Number(active.dataset.ep);
      modal.style.display = 'none';
      cleanup();
      resolve({ season, episode });
    }
    pickerCancel.addEventListener('click', onCancel);
    pickerPlay.addEventListener('click', onPlay);
  });
}

// ================= Detail / Player =================
async function openDetail(item, progress = null){
  if(!item) return;
  if(!item._media_type) item._media_type = mediaType(item);
  const detail = safeGet('detailScreen'); if(!detail) return;
  detail.style.display = 'flex'; document.body.style.overflow = 'hidden';

  const imgEl = safeGet('detailImage');
  if(imgEl) imgEl.src = item.backdrop_path ? `https://image.tmdb.org/t/p/w780${item.backdrop_path}` : (item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '');

  const titleEl = safeGet('detailTitle'); if(titleEl) titleEl.textContent = item.title || item.name || 'Untitled';
  const overEl = safeGet('detailOverview'); if(overEl) overEl.textContent = item.overview || 'No description available';
  const ratingEl = safeGet('detailRating'); if(ratingEl) ratingEl.textContent = `‚≠ê ${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}`;

  // load resume progress for this show
  if(item._media_type === 'tv'){
    const saved = JSON.parse(localStorage.getItem('continueWatching') || '{}');
    const key = `${item.id}-tv`;
    if(progress && progress.season && progress.episode){
      currentTV = item.id; currentSeason = Number(progress.season); currentEpisode = Number(progress.episode);
    } else if(saved[key]){
      currentTV = item.id; currentSeason = Number(saved[key].season); currentEpisode = Number(saved[key].episode);
    } else { currentTV = currentSeason = currentEpisode = null; }
    const pickBtn = safeGet('pickBtn'); if(pickBtn) pickBtn.style.display = 'inline-flex';
  } else {
    currentTV = currentSeason = currentEpisode = null;
    const pickBtn = safeGet('pickBtn'); if(pickBtn) pickBtn.style.display = 'none';
  }

  const watchBtn = safeGet('watchBtn');
  if(watchBtn){
    watchBtn.textContent = (item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode) ? `Resume S${currentSeason}¬∑E${currentEpisode}` : 'Watch Now';
    watchBtn.onclick = async () => {
      const iframe = safeGet('contentPlayer'); if(!iframe) return toast('Player not available');
      // safer sandbox - disallow popups / top navigation
      iframe.setAttribute('sandbox','allow-scripts');
      iframe.setAttribute('referrerpolicy','no-referrer');

      if(item._media_type === 'movie'){
        setPlayerSrc(`https://fmovies4u.com/embed/tmdb-movie-${item.id}`);
        safeGet('playerContainer') && (safeGet('playerContainer').style.display = 'flex');
        safeGet('nextBtn') && (safeGet('nextBtn').style.display = 'none');
        saveContinueWatching(item);
      } else {
        if(currentTV === item.id && currentSeason && currentEpisode){
          setPlayerSrc(`https://fmovies4u.com/embed/tmdb-tv-${item.id}/${currentSeason}/${currentEpisode}`);
          safeGet('playerContainer') && (safeGet('playerContainer').style.display = 'flex');
          safeGet('nextBtn') && (safeGet('nextBtn').style.display = 'flex');
          saveContinueWatching(item);
        } else {
          const sel = await openEpisodePicker(item.id, null);
          if(!sel) return;
          currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
          setPlayerSrc(`https://fmovies4u.com/embed/tmdb-tv-${item.id}/${currentSeason}/${currentEpisode}`);
          safeGet('playerContainer') && (safeGet('playerContainer').style.display = 'flex');
          safeGet('nextBtn') && (safeGet('nextBtn').style.display = 'flex');
          saveContinueWatching(item);
        }
      }
    };
  }

  const pickBtn = safeGet('pickBtn');
  if(pickBtn){
    pickBtn.onclick = async () => {
      if(item._media_type !== 'tv') return;
      const pre = (currentTV === item.id && currentSeason && currentEpisode) ? { season: currentSeason, episode: currentEpisode } : null;
      const sel = await openEpisodePicker(item.id, pre);
      if(!sel) return;
      currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
      setPlayerSrc(`https://fmovies4u.com/embed/tmdb-tv-${item.id}/${currentSeason}/${currentEpisode}`);
      safeGet('playerContainer') && (safeGet('playerContainer').style.display = 'flex');
      safeGet('nextBtn') && (safeGet('nextBtn').style.display = 'flex');
      saveContinueWatching(item);
    };
  }

  const trailerBtn = safeGet('trailerBtn');
  if(trailerBtn){
    trailerBtn.onclick = async () => {
      try {
        const res = await fetchAuth(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`);
        const data = await safeJson(res);
        const trailer = (data?.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer');
        if(trailer) window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank', 'noopener,noreferrer');
        else toast('Trailer not available');
      } catch(e){
        console.error('trailer', e);
        toast('Trailer fetch failed');
      }
    };
  }

  // check next episode (update next button visibility)
  if(item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode){
    checkNextEpisode(item.id, currentSeason, currentEpisode).catch(()=> { const nb = safeGet('nextBtn'); if(nb) nb.style.display = 'none'; });
  } else {
    const nb = safeGet('nextBtn'); if(nb) nb.style.display = 'none';
  }
}

// ================= Continue Watching =================
function saveContinueWatching(item){
  const type = mediaType(item);
  const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
  store[`${item.id}-${type}`] = {
    id: item.id,
    type,
    season: (type === 'tv') ? Number(currentSeason) : null,
    episode: (type === 'tv') ? Number(currentEpisode) : null,
    timestamp: Date.now()
  };
  localStorage.setItem('continueWatching', JSON.stringify(store));
  renderContinueWatching();
}

async function renderContinueWatching(){
  const section = safeGet('continueWatchingSection');
  const container = safeGet('continueWatching');
  if(!section || !container) return;
  container.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('continueWatching') || '{}');
  const keys = Object.keys(saved).sort((a,b) => (saved[b].timestamp || 0) - (saved[a].timestamp || 0));
  if(!keys.length){
    section.style.display = 'none'; return;
  }
  section.style.display = 'block';

  const fetches = keys.map(k => {
    const s = saved[k];
    return fetchAuth(`https://api.themoviedb.org/3/${s.type}/${s.id}?language=en-US`)
      .then(safeJson)
      .then(data => ({ key: k, meta: s, data }))
      .catch(e => ({ key: k, meta: s, data: null }));
  });

  const results = await Promise.all(fetches);
  results.forEach(r => {
    const k = r.key, s = r.meta, data = r.data;
    const card = document.createElement('div'); card.className = 'cont-card'; card.style.position = 'relative';
    if(!data){
      card.innerHTML = `<div style="background:#333;height:240px;"></div>`;
      container.appendChild(card); return;
    }
    data._media_type = s.type;
    const img = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : 'https://via.placeholder.com/500x750';
    const label = (s.type === 'tv' && s.season && s.episode) ? `S${s.season}¬∑E${s.episode}` : '';
    card.innerHTML = `
      <img src="${img}" alt="">
      <div style="position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,0.6);padding:4px 8px;border-radius:6px;font-size:12px;color:#fff;">${label}</div>
      <div style="position:absolute;right:6px;top:6px;display:flex;gap:6px;">
        <button class="edit-btn" style="background:#222;color:#fff;border-radius:6px;padding:6px;">‚úé</button>
        <button class="rm-btn" style="background:#f44336;color:#fff;border-radius:6px;padding:6px;">üóë</button>
      </div>
    `;
    // click -> open detail with progress
    card.addEventListener('click', (e) => { if(e.target.closest('.edit-btn') || e.target.closest('.rm-btn')) return; openDetail(data, { season: s.season, episode: s.episode }); });

    const editBtn = card.querySelector('.edit-btn');
    if(editBtn) editBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const sel = await openEpisodePicker(s.id, { season: s.season, episode: s.episode });
      if(!sel) return;
      const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
      store[k].season = sel.season; store[k].episode = sel.episode; store[k].timestamp = Date.now();
      localStorage.setItem('continueWatching', JSON.stringify(store));
      toast('Updated continue watching');
      renderContinueWatching();
    });

    const rmBtn = card.querySelector('.rm-btn');
    if(rmBtn) rmBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
      delete store[k];
      localStorage.setItem('continueWatching', JSON.stringify(store));
      renderContinueWatching();
    });

    container.appendChild(card);
  });
}

// ================= Next Episode =================
async function checkNextEpisode(tvId, season, episode){
  try {
    season = Number(season); episode = Number(episode);
    const sResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}?language=en-US`);
    const sData = await safeJson(sResp);
    const tvResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}?language=en-US`);
    const tvData = await safeJson(tvResp);
    const epsInSeason = sData?.episodes?.length || 0;
    let hasNext = (episode < epsInSeason);

    if(!hasNext){
      const maxSeason = tvData?.number_of_seasons || (tvData?.seasons ? Math.max(...tvData.seasons.map(s => s.season_number || 0)) : 0);
      for(let s = season + 1; s <= maxSeason; s++){
        try {
          const sRes = await fetchAuth(`https://api.themoviedb.org/3/tv/${tvId}/season/${s}?language=en-US`);
          const sData2 = await safeJson(sRes);
          if(sData2 && (sData2.episodes || []).length > 0){ hasNext = true; break; }
        } catch(e){ continue; }
      }
    }
    const nb = safeGet('nextBtn');
    if(nb) nb.style.display = hasNext ? 'flex' : 'none';
    return hasNext;
  } catch(e){
    console.error('checkNextEpisode', e);
    const nb = safeGet('nextBtn'); if(nb) nb.style.display = 'none';
    return false;
  }
}

safeGet('nextBtn') && safeGet('nextBtn').addEventListener('click', async () => {
  try {
    if(!currentTV) return;
    currentSeason = Number(currentSeason); currentEpisode = Number(currentEpisode);
    const sResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${currentTV}/season/${currentSeason}?language=en-US`);
    const sData = await safeJson(sResp);
    const total = sData?.episodes?.length || 0;
    currentEpisode++;
    if(currentEpisode > total){
      // try next seasons
      const tvResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${currentTV}?language=en-US`);
      const tvData = await safeJson(tvResp);
      let found = false;
      const maxSeason = tvData?.number_of_seasons || 0;
      for(let s = currentSeason + 1; s <= maxSeason; s++){
        try {
          const nResp = await fetchAuth(`https://api.themoviedb.org/3/tv/${currentTV}/season/${s}?language=en-US`);
          const nData = await safeJson(nResp);
          if(nData && (nData.episodes || []).length > 0){ currentSeason = s; currentEpisode = 1; found = true; break; }
        } catch(e) { continue; }
      }
      if(!found){ currentSeason = 1; currentEpisode = 1; } // wrap to start as a safe default
    }

    setPlayerSrc(`https://fmovies4u.com/embed/tmdb-tv-${currentTV}/${currentSeason}/${currentEpisode}`);

    // save progress
    const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
    store[`${currentTV}-tv`] = { id: currentTV, type: 'tv', season: currentSeason, episode: currentEpisode, timestamp: Date.now() };
    localStorage.setItem('continueWatching', JSON.stringify(store));
    renderContinueWatching();
    await checkNextEpisode(currentTV, currentSeason, currentEpisode);
  } catch(e){
    console.error('nextBtn handler', e);
    toast('Failed to load next episode');
  }
});

// ================= Close / Back =================
safeGet('backBtn') && safeGet('backBtn').addEventListener('click', () => {
  const player = safeGet('playerContainer'); if(player) player.style.display = 'none';
  const iframe = safeGet('contentPlayer'); if(iframe) iframe.src = '';
  currentTV = currentSeason = currentEpisode = null;
  const nb = safeGet('nextBtn'); if(nb) nb.style.display = 'none';
});
document.querySelector('#detailScreen .closeDetail') && document.querySelector('#detailScreen .closeDetail').addEventListener('click', () => {
  const det = safeGet('detailScreen'); if(det) det.style.display = 'none';
  document.body.style.overflow = 'auto';
});

// ================= Init =================
window.addEventListener('DOMContentLoaded', () => {
  const loadMoreBtn = safeGet('loadMoreBtn'); if(loadMoreBtn) loadMoreBtn.addEventListener('click', loadMore);
  const searchButton = safeGet('searchButton'); if(searchButton) searchButton.addEventListener('click', searchContent);
  const searchInput = safeGet('searchInput'); if(searchInput) searchInput.addEventListener('keydown', e => { if(e.key === 'Enter') searchContent(); });

  // render initial data
  loadTrending();
  renderContinueWatching();
});
</script>

</body>
</html>