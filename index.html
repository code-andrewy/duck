<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üçø Popcorn Hub Beta ‚Äî Full</title>

<!-- Cloudflare Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#060606;
  --card:#141414;
  --accent:#ffffff; /* white accent */
  --muted:#9a9a9a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#040404,#0e0e0e);
  color:#fff; font-family:Inter, "Segoe UI", Arial, sans-serif;
  -webkit-font-smoothing:antialiased;
}
.header{
  position:sticky; top:0; z-index:60; display:flex; align-items:center; gap:16px; padding:12px 18px;
  backdrop-filter: blur(6px); background: rgba(5,5,5,0.75);
}
.logo{ font-weight:800; color:var(--accent); display:flex; align-items:center; gap:8px; font-size:18px }
.search{ flex:1; display:flex; background:#111; padding:6px; border-radius:8px; gap:8px; align-items:center }
.search input{ flex:1; background:transparent; border:0; outline:0; color:#fff; padding:8px; font-size:14px; }

/* white buttons (accent) with black text for contrast */
.btn{ background:var(--accent); border:0; color:#000; padding:8px 12px; border-radius:8px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
.btn.secondary{ background:#333; color:#fff; }

.container{ max-width:1200px; margin:0 auto; padding:20px 16px 40px 16px; }
.section{ margin-bottom:26px; }
.h2{ display:flex; align-items:center; gap:8px; margin-bottom:12px; font-size:18px; }
.grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; }
.card{ background:var(--card); border-radius:10px; overflow:hidden; cursor:pointer; position:relative; transition:transform .18s; }
.card:hover{ transform:translateY(-6px) }
.card img{ width:100%; height:220px; object-fit:cover; display:block }
.card .title{ padding:8px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.overlay{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; opacity:0; background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55)); transition:.14s }
.card:hover .overlay{ opacity:1 }
.play-fab{ width:56px; height:56px; border-radius:50%; background:var(--accent); color:#000; display:grid; place-items:center; font-size:18px; box-shadow:0 8px 20px rgba(0,0,0,0.6) }

/* remove/trash button on cards */
.remove-btn{
  position:absolute;
  top:8px;
  right:8px;
  background:rgba(0,0,0,0.6);
  border:0;
  color:#fff;
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
  display:grid;
  place-items:center;
  z-index:20;
}
.remove-btn:hover{ background:#fff; color:#000; }

/* DETAILS PAGE */
#details{ display:none; padding-bottom:40px }
.details-hero{ display:flex; gap:20px; align-items:flex-start }
.details-hero img{ width:320px; border-radius:12px; object-fit:cover }
.details-right{ flex:1 }
.small{ color:var(--muted); font-size:13px }

/* PLAYER - FULLSCREEN IFRAME */
#player{ display:none; position:fixed; inset:0; z-index:999; background:#000; }

/* top controls sit above iframe */
.player-top{
  position:fixed;
  top:12px;
  left:12px;
  right:12px;
  z-index:1001;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  pointer-events:auto;
}
.player-top .left, .player-top .right { display:flex; gap:8px; align-items:center; }

/* full-bleed iframe behind controls */
#player iframe{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  border:0;
  z-index:1000;
}

/* hide empty sections */
.hidden { display:none !important; }

@media (max-width:900px){
  .card img{ height:180px }
  .details-hero{ flex-direction:column }
  .details-hero img{ width:100% }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">üçø Popcorn Hub <small style="font-size:12px;color:#ddd">Beta</small></div>
  <div class="search" role="search">
    <input id="searchInput" placeholder="Search movies or TV shows ‚Äî try 'inception'">
    <button id="searchBtn" class="btn" title="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
  </div>
  <button id="homeBtn" class="btn" title="Home"><i class="fa-solid fa-house-chimney"></i></button>
</div>

<!-- HOME -->
<main id="home" class="container" aria-live="polite">

  <section id="continueSection" class="section">
    <div class="h2"><i class="fa-solid fa-clock-rotate-left"></i> Continue Watching</div>
    <div id="continueGrid" class="grid"></div>
  </section>

  <section id="watchlistSection" class="section">
    <div class="h2"><i class="fa-solid fa-heart"></i> Watchlist</div>
    <div id="watchlistGrid" class="grid"></div>
  </section>

  <section class="section">
    <div class="h2" id="mainTitle"><i class="fa-solid fa-fire"></i> Trending</div>
    <div id="mainGrid" class="grid"></div>
  </section>

</main>

<!-- DETAILS PAGE (full screen) -->
<main id="details" class="container" aria-hidden="true">
  <button id="detailsBack" class="btn secondary"><i class="fa-solid fa-arrow-left"></i> Back</button>

  <div class="details-hero" style="margin-top:16px">
    <img id="dPoster" src="" alt="Poster">
    <div class="details-right">
      <h1 id="dTitle"></h1>
      <div id="dMeta" class="small" style="margin-bottom:8px"></div>
      <p id="dOverview" class="small"></p>

      <div style="margin-top:16px; display:flex; gap:8px; align-items:center">
        <button id="playBtn" class="btn"><i class="fa-solid fa-play"></i> Play</button>
        <button id="trailerBtn" class="btn secondary"><i class="fa-brands fa-youtube"></i> Trailer</button>
        <button id="addBtn" class="btn secondary"><i class="fa-solid fa-plus"></i> Add to Watchlist</button>
      </div>
    </div>
  </div>
</main>

<!-- PLAYER (full-screen iframe) -->
<div id="player" aria-hidden="true">
  <div class="player-top" role="toolbar" aria-label="Player controls">
    <div class="left">
      <button id="playerBack" class="btn secondary"><i class="fa-solid fa-arrow-left"></i> Back</button>
    </div>
    <div class="right">
      <button id="prevEp" class="btn secondary" title="Previous Episode"><i class="fa-solid fa-backward-step"></i></button>
      <button id="nextEp" class="btn" title="Next Episode"><i class="fa-solid fa-forward-step"></i> Next</button>
      <button id="playerClose" class="btn secondary"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>
  </div>

  <iframe id="playerFrame" title="player" sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
</div>

<script>
/* =========================
   CONFIG (using provided TMDB Bearer token)
   ========================= */
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
const headers = { Authorization: `Bearer ${API_KEY}`, 'Content-Type': 'application/json' };

/* DOM shortcuts */
const $ = id => document.getElementById(id);
const mainGrid = $('mainGrid');
const mainTitle = $('mainTitle');
const searchInput = $('searchInput');
const searchBtn = $('searchBtn');
const homeBtn = $('homeBtn');

const continueSection = $('continueSection');
const continueGrid = $('continueGrid');
const watchlistSection = $('watchlistSection');
const watchlistGrid = $('watchlistGrid');

const detailsPage = $('details');
const homePage = $('home');
const detailsBack = $('detailsBack');
const dPoster = $('dPoster');
const dTitle = $('dTitle');
const dOverview = $('dOverview');
const dMeta = $('dMeta');
const playBtn = $('playBtn');
const trailerBtn = $('trailerBtn');
const addBtn = $('addBtn');

const player = $('player');
const playerFrame = $('playerFrame');
const playerBack = $('playerBack');
const playerClose = $('playerClose');
const nextEpBtn = $('nextEp');
const prevEpBtn = $('prevEp');

let lastDetails = null;
let currentPlayerItem = null;
let currentSeason = 1;
let currentEpisode = 1;
const tvCache = {};

/* Cookie helpers */
function setCookie(name, value, days = 60) {
  const v = encodeURIComponent(JSON.stringify(value));
  document.cookie = `${name}=${v};path=/;max-age=${days*24*3600};SameSite=Lax`;
}
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? JSON.parse(decodeURIComponent(m[2])) : null;
}

/* Block default link behavior globally (trailer will open via window.open explicitly) */
document.addEventListener('click', e => {
  if (e.target.tagName === 'A' && !e.target.classList.contains('trailer-link')) {
    e.preventDefault();
  }
});

/* Utility */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function imgPath(p, size='w500'){ return p ? `https://image.tmdb.org/t/p/${size}${p}` : ''; }

/* =========================
   UI: cards creation
   ========================= */
function createCard(item){
  const root = document.createElement('div');
  root.className = 'card';
  const title = item.title || item.name || 'Untitled';
  const poster = imgPath(item.poster_path, 'w500');
  root.innerHTML = `
    <img src="${poster}" alt="${escapeHtml(title)}">
    <div class="overlay"><div class="play-fab" title="Play"><i class="fa-solid fa-play"></i></div></div>
    <div class="title">${escapeHtml(title)}</div>
  `;
  // open details on click
  root.addEventListener('click', () => openDetails(item));
  // play-fab goes to details (require visiting details first)
  root.querySelector('.play-fab').addEventListener('click', ev => {
    ev.stopPropagation();
    openDetails(item);
  });
  return root;
}

/* =========================
   Trending / Search
   ========================= */
async function loadTrending(){
  mainTitle.textContent = 'üî• Trending';
  try {
    const res = await fetch('https://api.themoviedb.org/3/trending/all/week?language=en-US', { headers });
    const data = await res.json();
    mainGrid.innerHTML = '';
    (data.results || []).slice(0,36).forEach(i => mainGrid.appendChild(createCard(i)));
  } catch(err) {
    console.error(err);
    mainGrid.innerHTML = `<div class="card"><div class="title">Failed to load trending</div></div>`;
  }
}

searchBtn.addEventListener('click', doSearch);
searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

async function doSearch(){
  const q = searchInput.value.trim();
  if (!q) {
    loadTrending();
    return;
  }
  mainTitle.textContent = `üîé Results for "${q}"`;
  mainGrid.innerHTML = `<div class="card"><div class="title">Searching‚Ä¶</div></div>`;
  try {
    const res = await fetch(`https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(q)}&page=1&language=en-US`, { headers });
    const data = await res.json();
    mainGrid.innerHTML = '';
    const items = data.results || [];
    if (!items.length) {
      mainGrid.innerHTML = `<div class="card"><div class="title">No results</div></div>`;
      return;
    }
    items.slice(0,36).forEach(i => mainGrid.appendChild(createCard(i)));
  } catch(err) {
    console.error(err);
    mainGrid.innerHTML = `<div class="card"><div class="title">Search failed</div></div>`;
  }
}

/* =========================
   Watchlist & Continue ‚Äî load, render, remove
   ========================= */
function loadWatchlist() {
  const list = getCookie('watchlist') || [];
  watchlistGrid.innerHTML = '';
  if (!list.length) {
    watchlistSection.classList.add('hidden');
    return;
  }
  watchlistSection.classList.remove('hidden');
  list.forEach(item => {
    const c = document.createElement('div');
    c.className = 'card';
    const poster = imgPath(item.poster_path, 'w300');
    c.innerHTML = `
      <img src="${poster}" alt="${escapeHtml(item.title || item.name)}">
      <button class="remove-btn" title="Remove from watchlist"><i class="fa fa-trash"></i></button>
      <div class="title">${escapeHtml(item.title || item.name)}</div>
    `;
    c.addEventListener('click', () => openDetails(item));
    c.querySelector('.remove-btn').addEventListener('click', ev => {
      ev.stopPropagation();
      removeWatchlist(item.id);
    });
    watchlistGrid.appendChild(c);
  });
}

function removeWatchlist(id){
  let list = getCookie('watchlist') || [];
  list = list.filter(i => i.id !== id);
  setCookie('watchlist', list);
  loadWatchlist();
}

function loadContinue() {
  const list = getCookie('continue') || [];
  continueGrid.innerHTML = '';
  if (!list.length) {
    continueSection.classList.add('hidden');
    return;
  }
  continueSection.classList.remove('hidden');
  list.forEach(item => {
    const epInfo = item.season ? `S${item.season} ‚Ä¢ E${item.episode || 1}` : '';
    const c = document.createElement('div');
    c.className = 'card';
    const poster = imgPath(item.poster_path, 'w300');
    c.innerHTML = `
      <img src="${poster}" alt="${escapeHtml(item.title || item.name)}">
      <button class="remove-btn" title="Remove from continue"><i class="fa fa-trash"></i></button>
      <div class="title">${escapeHtml(item.title || item.name)}</div>
      <div class="small" style="padding:8px">${epInfo}</div>
    `;
    c.addEventListener('click', () => openDetails(item));
    c.querySelector('.remove-btn').addEventListener('click', ev => {
      ev.stopPropagation();
      removeContinue(item.id);
    });
    continueGrid.appendChild(c);
  });
}

function removeContinue(id){
  let list = getCookie('continue') || [];
  list = list.filter(i => i.id !== id);
  setCookie('continue', list);
  loadContinue();
}

/* Add to watchlist & save continue */
function addToWatchlist(item){
  const list = getCookie('watchlist') || [];
  if (!list.find(x => x.id === item.id)) {
    list.unshift(item);
    setCookie('watchlist', list);
    loadWatchlist();
  }
}
function saveContinue(item, season=1, episode=1){
  let list = getCookie('continue') || [];
  list = list.filter(x => x.id !== item.id);
  const toSave = Object.assign({}, item, { season, episode });
  list.unshift(toSave);
  setCookie('continue', list.slice(0,12));
  loadContinue();
}

/* =========================
   Details page
   ========================= */
async function openDetails(item){
  lastDetails = item;
  // show details page and hide home
  homePage.style.display = 'none';
  detailsPage.style.display = 'block';
  detailsPage.setAttribute('aria-hidden','false');
  dPoster.src = imgPath(item.poster_path, 'w500');
  dTitle.textContent = item.title || item.name || 'Untitled';
  dOverview.textContent = item.overview || 'No overview available.';
  dMeta.textContent = `${(item.release_date || item.first_air_date || '').slice(0,4) || ''} ‚Ä¢ ${item.media_type || ''}`;
  scrollTo(0,0);
}
detailsBack.addEventListener('click', ()=> {
  detailsPage.style.display = 'none';
  detailsPage.setAttribute('aria-hidden','true');
  homePage.style.display = 'block';
});

/* Details actions */
addBtn.addEventListener('click', ()=> {
  if (!lastDetails) return;
  addToWatchlist(lastDetails);
  alert('Added to Watchlist');
});
trailerBtn.addEventListener('click', async ()=> {
  if (!lastDetails) return;
  try {
    const type = lastDetails.media_type === 'tv' ? 'tv' : 'movie';
    const res = await fetch(`https://api.themoviedb.org/3/${type}/${lastDetails.id}/videos?language=en-US`, { headers });
    const d = await res.json();
    const t = (d.results||[]).find(v => v.type === 'Trailer') || (d.results||[])[0];
    if (t) window.open(`https://www.youtube.com/watch?v=${t.key}`, '_blank');
    else alert('No trailer found');
  } catch(e){ console.error(e); alert('Trailer lookup failed'); }
});

/* =========================
   Player: must play from details
   ========================= */
playBtn.addEventListener('click', async ()=> {
  if (!lastDetails) return;
  currentPlayerItem = lastDetails;
  if (currentPlayerItem.media_type === 'tv') {
    const cont = (getCookie('continue')||[]).find(x => x.id === currentPlayerItem.id);
    currentSeason = cont?.season || 1;
    currentEpisode = cont?.episode || 1;
    openPlayerTv(currentPlayerItem.id, currentSeason, currentEpisode);
  } else {
    openPlayerMovie(currentPlayerItem.id);
  }
  // hide details (player full-screen)
  detailsPage.style.display = 'none';
});

/* open player functions */
function openPlayerMovie(id){
  playerFrame.src = `https://fmovies4u.com/embed/tmdb-movie-${id}`;
  player.style.display = 'block';
  player.setAttribute('aria-hidden','false');
  setCookie('lastPlayed', { id, media_type: 'movie', time: Date.now() }, 30);
}

async function openPlayerTv(tvId, seasonNum=1, episodeNum=1){
  currentSeason = seasonNum; currentEpisode = episodeNum;
  playerFrame.src = `https://fmovies4u.com/embed/tmdb-tv-${tvId}-season/${seasonNum}-eps/${episodeNum}`;
  player.style.display = 'block';
  player.setAttribute('aria-hidden','false');
  saveContinue(lastDetails, seasonNum, episodeNum);
  setCookie('lastPlayed', { id: tvId, media_type: 'tv', season: seasonNum, episode: episodeNum, time: Date.now() }, 30);
}

/* =========================
   Next / Prev episode (auto-advance across seasons)
   ========================= */
async function fetchTvDetails(tvId){
  if (tvCache[tvId]) return tvCache[tvId];
  try {
    const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?language=en-US`, { headers });
    const d = await res.json();
    tvCache[tvId] = d;
    return d;
  } catch(e){ console.error(e); return null; }
}

nextEpBtn.addEventListener('click', async ()=> {
  if (!currentPlayerItem || currentPlayerItem.media_type !== 'tv') return;
  const tvId = currentPlayerItem.id;
  const tvd = await fetchTvDetails(tvId);
  if (!tvd) { alert('Unable to fetch show info'); return; }
  const seasons = (tvd.seasons || []).slice().sort((a,b)=>a.season_number - b.season_number);
  let curSeason = seasons.find(s => s.season_number === currentSeason);
  if (!curSeason || !curSeason.episode_count) {
    try {
      const sr = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${currentSeason}?language=en-US`, { headers });
      const sd = await sr.json();
      curSeason = { ...curSeason, episode_count: (sd.episodes||[]).length };
    } catch(e){}
  }
  const maxEp = curSeason?.episode_count || 0;
  if (currentEpisode < maxEp) {
    currentEpisode++;
    openPlayerTv(tvId, currentSeason, currentEpisode);
  } else {
    const nextSeason = seasons.find(s => s.season_number > currentSeason && (s.episode_count || 0) > 0);
    if (nextSeason) {
      currentSeason = nextSeason.season_number;
      currentEpisode = 1;
      openPlayerTv(tvId, currentSeason, currentEpisode);
    } else {
      alert('No next episode/season available.');
    }
  }
});

prevEpBtn.addEventListener('click', async ()=> {
  if (!currentPlayerItem || currentPlayerItem.media_type !== 'tv') return;
  const tvId = currentPlayerItem.id;
  const tvd = await fetchTvDetails(tvId);
  if (!tvd) { alert('Unable to fetch show info'); return; }
  if (currentEpisode > 1) {
    currentEpisode--;
    openPlayerTv(tvId, currentSeason, currentEpisode);
  } else {
    const seasons = (tvd.seasons || []).slice().sort((a,b)=>a.season_number - b.season_number);
    const prevSeasons = seasons.filter(s => s.season_number < currentSeason).reverse();
    const prev = prevSeasons.find(s => (s.episode_count || 0) > 0);
    if (prev) {
      currentSeason = prev.season_number;
      currentEpisode = prev.episode_count || 1;
      openPlayerTv(tvId, currentSeason, currentEpisode);
    } else {
      alert('No previous episode found.');
    }
  }
});

/* Player top controls */
playerBack.addEventListener('click', ()=> {
  playerFrame.src = '';
  player.style.display = 'none';
  player.setAttribute('aria-hidden','true');
  // return to details if available, otherwise home
  if (lastDetails) {
    detailsPage.style.display = 'block';
  } else {
    homePage.style.display = 'block';
  }
});
playerClose.addEventListener('click', ()=> {
  playerFrame.src = '';
  player.style.display = 'none';
  player.setAttribute('aria-hidden','true');
});

/* Save lastPlayed */
function saveLastPlayed(obj){ setCookie('lastPlayed', obj, 30); }

/* =========================
   Home / init
   ========================= */
homeBtn.addEventListener('click', ()=> {
  detailsPage.style.display = 'none';
  player.style.display = 'none';
  homePage.style.display = 'block';
  searchInput.value = '';
  loadTrending();
});

async function init(){
  loadWatchlist();
  loadContinue();
  await loadTrending();
}
init();

/* make Enter in search work */
searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') doSearch(); });

/* small helper: allow double-click to delete from watchlist quickly (optional) */
watchlistGrid.addEventListener('dblclick', ev => {
  const el = ev.target.closest('.card');
  if (!el) return;
  const title = el.querySelector('.title')?.textContent;
  if (!title) return;
  let list = getCookie('watchlist') || [];
  list = list.filter(x => (x.title || x.name) !== title);
  setCookie('watchlist', list);
  loadWatchlist();
});
</script>
</body>
</html>