<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üé¨ Popcorn Hub üçø Beta</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
/* --- CSS from previous version --- */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#0d0d0d; color:#fff; overflow-x:hidden;}
h1 {text-align:center;padding:20px 0 5px;font-size:2.5rem;}
h3 {text-align:center;font-weight:400;color:#ccc;margin-top:-5px;font-size:16px;font-style:italic;}
.search-container {display:flex;justify-content:center;gap:12px;margin:0 20px 30px;padding:12px 20px;backdrop-filter:blur(12px);background:rgba(255,255,255,0.08);border-radius:25px;box-shadow:0 8px 32px rgba(0,0,0,0.4);flex-wrap:wrap;}
#searchInput {flex:1 1 300px;padding:12px 20px;font-size:16px;border-radius:25px;border:none;outline:none;background:rgba(255,255,255,0.06);color:#fff;}
#searchInput:hover,#searchInput:focus{background:rgba(255,255,255,0.14);}
#searchButton{padding:12px 26px;border-radius:25px;border:none;cursor:pointer;font-weight:600;background:#fff;color:#111;}
#searchButton:hover{transform:scale(1.05);}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:0 20px 40px;}
.movie-card,.cont-card{position:relative;overflow:hidden;border-radius:14px;cursor:pointer;transition:transform 0.25s ease;}
.movie-card:hover,.cont-card:hover{transform:translateY(-4px);}
.movie-card img,.cont-card img{width:100%;height:330px;object-fit:cover;transition:transform 0.35s ease;}
.cont-card img{height:250px;}
.movie-card:hover img,.cont-card:hover img{transform:scale(1.06);}
.movie-card .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);opacity:0;display:flex;align-items:center;justify-content:center;font-size:48px;}
.movie-card:hover .overlay{opacity:1;}
.movie-card .title{position:absolute;bottom:0;width:100%;padding:10px;background:linear-gradient(to top,rgba(0,0,0,0.9),transparent);text-align:center;font-weight:bold;}
.cont-card .remove-btn{position:absolute;top:6px;right:6px;background:#f44336;border:none;border-radius:12px;padding:5px 8px;color:#fff;cursor:pointer;display:none;}
.cont-card:hover .remove-btn{display:block;}
#loadMoreBtn{display:block;margin:20px auto 40px;padding:12px 30px;font-size:16px;border-radius:25px;border:none;background:#fff;color:#000;cursor:pointer;}
#loadMoreBtn:hover{transform:scale(1.05);}
#detailScreen{display:none;position:fixed;inset:0;background:#111;z-index:9999;overflow-y:auto;padding:40px 20px;animation:fadeIn 0.4s ease;}
#detailScreen .closeDetail{position:fixed;top:20px;right:20px;font-size:36px;background:none;border:none;color:#fff;cursor:pointer;z-index:10001;}
#detailScreen .banner img{width:100%;max-height:60vh;object-fit:cover;border-radius:16px;}
#detailScreen .info{max-width:800px;margin:20px auto;text-align:center;}
#detailScreen h2{font-size:32px;}
#detailScreen .rating{color:#ffd700;margin-bottom:15px;}
#detailScreen p{font-size:18px;line-height:1.5;color:#ccc;}
#detailScreen .buttons{display:flex;justify-content:center;gap:20px;margin-top:20px;flex-wrap:wrap;}
#detailScreen .buttons button{padding:15px 30px;font-size:18px;border-radius:25px;border:none;cursor:pointer;font-weight:bold;}
#watchBtn{background:#e50914;color:#fff;}
#watchBtn:hover{transform:scale(1.05);}
#trailerBtn{background:rgba(255,255,255,0.12);color:#fff;}
#trailerBtn:hover{background:rgba(255,255,255,0.2);transform:scale(1.05);}
#playerContainer{display:none;position:fixed;inset:0;background:#000;z-index:10000;}
#playerContainer iframe{width:100%;height:100%;border:none;}
#backBtn,#nextBtn{position:absolute;top:20px;padding:10px 16px;border-radius:12px;background:rgba(0,0,0,0.85);color:#fff;border:none;cursor:pointer;font-size:18px;z-index:10001;display:flex;align-items:center;gap:8px;}
#backBtn{right:20px;}#nextBtn{left:20px;}
#backBtn:hover,#nextBtn:hover{background:#000;transform:scale(1.05);}
#continueWatchingSection{display:none;margin:20px 0;}
#continueWatchingSection h2{margin-left:20px;font-size:1.4rem;}
#continueWatching{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px;padding:0 20px;}
#toastContainer{position:fixed;top:20px;right:20px;z-index:10002;display:flex;flex-direction:column;gap:10px;}
.toast{padding:12px 20px;background:rgba(0,0,0,0.7);border-radius:12px;font-size:14px;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@media (max-width:600px){.movie-card img{height:280px;}#detailScreen h2{font-size:24px;}}
</style>
</head>
<body>

<h1>üé¨ Popcorn Hub üçø Beta</h1>
<h3>Mathematically proven to make your day better :)</h3>
<h3>How's your day going?</h3>

<div class="search-container">
  <input type="text" id="searchInput" placeholder=" What are you gonna watch today? üçø">
  <button id="searchButton"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
</div>

<div id="continueWatchingSection">
  <h2><i class="fa-solid fa-play-circle"></i> Continue Watching</h2>
  <div id="continueWatching"></div>
</div>

<div id="trending" class="grid"></div>
<button id="loadMoreBtn">load more results</button>

<div id="detailScreen">
  <button class="closeDetail"><i class="fa-solid fa-xmark"></i></button>
  <div class="banner"><img id="detailImage" src="" alt=""></div>
  <div class="info">
    <h2 id="detailTitle"></h2>
    <div class="rating" id="detailRating"></div>
    <p id="detailOverview"></p>
    <div class="buttons">
      <button id="watchBtn"><i class="fa-solid fa-play"></i> Watch Now</button>
      <button id="trailerBtn"><i class="fa-solid fa-film"></i> Trailer</button>
    </div>
  </div>
</div>

<div id="playerContainer">
  <button id="nextBtn"><i class="fa-solid fa-forward"></i> Next Episode</button>
  <button id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back</button>
  <iframe id="contentPlayer"></iframe>
</div>

<div id="toastContainer"></div>

<script>
// --- TMDB API KEY ---
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
const ITEMS_PER_PAGE = 15;

// --- STATE ---
let trendingData = [];
let currentIndex = 0;
let currentTV = null;
let currentSeason = null;
let currentEpisode = null;

// --- HELPERS ---
const $ = id => document.getElementById(id);
function toast(msg, dur=3000){
    const c = $('toastContainer');
    if(!c) return;
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(()=>{ t.remove(); }, dur);
}
function getMediaType(item){ return item._media_type || (item.title ? 'movie':'tv'); }
function saveProgress(item){
    const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
    saved[`${item.id}-${getMediaType(item)}`]={
        id:item.id,
        type:getMediaType(item),
        season:currentSeason,
        episode:currentEpisode,
        timestamp:Date.now()
    };
    localStorage.setItem('continueWatching', JSON.stringify(saved));
    renderContinueWatching();
}

// --- EMBEDS ---
const movieEmbed = id => `https://fmovies4u.com/embed/tmdb-movie-${id}`;
const tvEmbed = (id,s,e) => `https://fmovies4u.com/embed/tmdb-tv-${id}/${s}/${e}`;

// --- TRENDING ---
async function loadTrending(){
    try{
        const [m,t] = await Promise.all([
            fetch('https://api.themoviedb.org/3/trending/movie/week',{headers:{Authorization:`Bearer ${API_KEY}`}}),
            fetch('https://api.themoviedb.org/3/trending/tv/week',{headers:{Authorization:`Bearer ${API_KEY}`}})
        ]);
        if(!m.ok || !t.ok){ toast('Failed to load trending'); return; }
        const md = await m.json(), td = await t.json();
        trendingData = [...(md.results||[]).map(i=>({...i,_media_type:'movie'})),
                        ...(td.results||[]).map(i=>({...i,_media_type:'tv'}))]
                        .sort((a,b)=>(b.popularity||0)-(a.popularity||0));
        currentIndex=0;
        $('trending').innerHTML='';
        loadMore();
    }catch(e){ console.error(e); toast('Failed to load trending'); }
}

function loadMore(){
    const container = $('trending');
    if(!container) return;
    const nextItems = trendingData.slice(currentIndex,currentIndex+ITEMS_PER_PAGE);
    nextItems.forEach(i=>container.appendChild(createCard(i)));
    currentIndex+=nextItems.length;
    $('loadMoreBtn').style.display = currentIndex>=trendingData.length?'none':'block';
}

function createCard(item){
    const card = document.createElement('div');
    card.className='movie-card';
    const img = item.poster_path?`https://image.tmdb.org/t/p/w500${item.poster_path}`:'https://via.placeholder.com/500x750';
    card.innerHTML = `
        <img src="${img}" alt="${item.title||item.name}">
        <div class="title">${item.title||item.name}</div>
        <div class="overlay"><i class="fa-solid fa-play"></i></div>
    `;
    card.onclick = ()=> openDetail(item);
    return card;
}

// --- SEARCH ---
async function searchContent(){
    const query = $('searchInput').value.trim();
    if(!query) return toast('Enter a search term');
    try{
        const [m,t] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(query)}`,{headers:{Authorization:`Bearer ${API_KEY}`}}),
            fetch(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(query)}`,{headers:{Authorization:`Bearer ${API_KEY}`}})
        ]);
        const md = await m.json(), td = await t.json();
        trendingData = [...(md.results||[]).map(i=>({...i,_media_type:'movie'})),
                        ...(td.results||[]).map(i=>({...i,_media_type:'tv'}))];
        currentIndex=0;
        $('trending').innerHTML='';
        if(!trendingData.length){
            $('trending').innerHTML='<p style="padding:20px;color:#ccc">No results</p>';
            $('loadMoreBtn').style.display='none';
            return;
        }
        loadMore();
    }catch(e){ console.error(e); toast('Search failed'); }
}

// --- DETAIL SCREEN ---
function openDetail(item){
    item._media_type = getMediaType(item);
    $('detailScreen').style.display='flex';
    document.body.style.overflow='hidden';
    $('detailImage').src = item.backdrop_path?`https://image.tmdb.org/t/p/w780${item.backdrop_path}`:
                                                (item.poster_path?`https://image.tmdb.org/t/p/w500${item.poster_path}`:'https://via.placeholder.com/780x439');
    $('detailTitle').textContent=item.title||item.name||'Untitled';
    $('detailOverview').textContent=item.overview||'No description';
    $('detailRating').textContent=`‚≠ê ${item.vote_average?.toFixed(1)||'N/A'}`;
    
    $('watchBtn').onclick = ()=> watchContent(item);
    $('trailerBtn').onclick = ()=> openTrailer(item);

    // Load saved progress if TV
    if(item._media_type==='tv'){
        const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
        const prog = saved[`${item.id}-tv`];
        if(prog){ currentTV=prog.id; currentSeason=prog.season; currentEpisode=prog.episode; }
        else { currentTV=currentSeason=currentEpisode=null; }
    }else{ currentTV=currentSeason=currentEpisode=null; }
}

// --- WATCH ---
async function watchContent(item){
    const iframe = $('contentPlayer');
    iframe.setAttribute('sandbox','allow-same-origin allow-scripts allow-forms');
    $('playerContainer').style.display='flex';

    if(item._media_type==='movie'){
        iframe.src = movieEmbed(item.id);
        $('nextBtn').style.display='none';
    } else {
        if(!currentSeason || !currentEpisode){
            const se = await selectSeasonEpisode(item.id);
            if(!se) return;
            currentSeason=se.season;
            currentEpisode=se.episode;
        }
        iframe.src = tvEmbed(item.id,currentSeason,currentEpisode);
        $('nextBtn').style.display='flex';
    }
    saveProgress(item);
}

// --- SEASON/EPISODE PICK ---
async function selectSeasonEpisode(tvId){
    try{
        const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        if(!res.ok) return toast('Failed to get show info');
        const data = await res.json();
        let season;
        do{
            const val = prompt(`Enter season (1-${data.number_of_seasons})`);
            if(val===null) return null;
            season=parseInt(val);
        }while(!season || season<1 || season>data.number_of_seasons);
        const sRes = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        if(!sRes.ok) return toast('Failed to get season info');
        const sData = await sRes.json();
        let episode;
        do{
            const val = prompt(`Enter episode (1-${sData.episodes.length})`);
            if(val===null) return null;
            episode=parseInt(val);
        }while(!episode || episode<1 || episode>sData.episodes.length);
        return {season, episode};
    }catch(e){ console.error(e); toast('Failed to select episode'); return null; }
}

// --- NEXT EPISODE ---
$('nextBtn').onclick = async ()=>{
    try{
        if(!currentTV) return;
        const sRes = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${currentSeason}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        if(!sRes.ok) throw new Error('Season fetch failed');
        const sData = await sRes.json();
        currentEpisode++;
        if(currentEpisode > sData.episodes.length){
            const tvRes = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
            if(!tvRes.ok) throw new Error('TV fetch failed');
            const tvData = await tvRes.json();
            let found=false;
            for(let s=currentSeason+1; s<=tvData.number_of_seasons; s++){
                const nRes = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${s}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
                if(!nRes.ok) continue;
                const nData = await nRes.json();
                if(nData.episodes.length>0){ currentSeason=s; currentEpisode=1; found=true; break; }
            }
            if(!found){ toast('Last episode reached'); $('nextBtn').style.display='none'; return; }
        }
        $('contentPlayer').src = tvEmbed(currentTV,currentSeason,currentEpisode);
        saveProgress({id:currentTV,_media_type:'tv'});
    }catch(e){ console.error(e); toast('Failed to load next episode'); }
};

// --- CONTINUE WATCHING ---
async function renderContinueWatching(){
    const section=$('continueWatchingSection');
    const container=$('continueWatching');
    if(!container || !section) return;
    container.innerHTML='';
    const saved = JSON.parse(localStorage.getItem('continueWatching')||'{}');
    const keys = Object.keys(saved).sort((a,b)=>(saved[b].timestamp||0)-(saved[a].timestamp||0));
    if(!keys.length){ section.style.display='none'; return; }
    section.style.display='block';
    for(const k of keys){
        const s = saved[k];
        try{
            const res = await fetch(`https://api.themoviedb.org/3/${s.type}/${s.id}?language=en-US`,{headers:{Authorization:`Bearer ${API_KEY}`}});
            if(!res.ok) throw new Error('fetch failed');
            const data = await res.json();
            data._media_type = s.type;
            const card=document.createElement('div');
            card.className='cont-card';
            const imgSrc = data.poster_path?`https://image.tmdb.org/t/p/w500${data.poster_path}`:'https://via.placeholder.com/500x750';
            card.innerHTML=`<img src="${imgSrc}" alt=""><button class="remove-btn"><i class="fa-solid fa-trash"></i></button>`;
            card.onclick = ()=> openDetail(data);
            card.querySelector('.remove-btn').onclick = e=>{
                e.stopPropagation();
                delete saved[k];
                localStorage.setItem('continueWatching',JSON.stringify(saved));
                renderContinueWatching();
            };
            container.appendChild(card);
        }catch(e){ console.error(e); }
    }
}

// --- TRAILER ---
async function openTrailer(item){
    try{
        const res = await fetch(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`,{headers:{Authorization:`Bearer ${API_KEY}`}});
        if(!res.ok){ toast('Trailer not available'); return; }
        const data = await res.json();
        const trailer = (data.results||[]).find(v=>v.site==='YouTube' && v.type==='Trailer');
        if(trailer) window.open(`https://www.youtube.com/watch?v=${trailer.key}`,'_blank','noopener');
        else toast('Trailer not available');
    }catch(e){ console.error(e); toast('Failed to load trailer'); }
}

// --- CLOSE PLAYER/DETAIL ---
$('backBtn').onclick=()=>{
    $('playerContainer').style.display='none';
    $('contentPlayer').src='';
    currentTV=currentSeason=currentEpisode=null;
    $('nextBtn').style.display='none';
};
document.querySelector('.closeDetail').onclick=()=>{
    $('detailScreen').style.display='none';
    document.body.style.overflow='auto';
};

// --- INIT ---
window.onload = ()=>{
    loadTrending();
    renderContinueWatching();
    $('loadMoreBtn').onclick = loadMore;
    $('searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') searchContent(); });
};
</script>

</body>
</html>