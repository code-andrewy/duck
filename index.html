<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¨ Popcorn Hub üçø Beta</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ================= RESET ================= */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0d0d0d;
    color: #fff;
    overflow-x: hidden;
}

/* ================= HEADERS ================= */
h1 {
    text-align: center;
    font-size: 3rem;
    padding: 25px 0 5px;
}
h3 {
    text-align: center;
    font-weight: 400;
    color: #ccc;
    margin-top: 5px;
    font-size: 16px;
    font-style: italic;
}

/* ================= SEARCH ================= */
.search-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin: 20px;
    padding: 12px 20px;
    backdrop-filter: blur(12px);
    background: rgba(255, 255, 255, 0.08);
    border-radius: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    flex-wrap: wrap;
}

#searchInput {
    flex: 1 1 300px;
    padding: 14px 22px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    outline: none;
    background: rgba(255, 255, 255, 0.06);
    color: #fff;
}
#searchInput:focus,
#searchInput:hover { background: rgba(255, 255, 255, 0.14); }

#searchButton {
    padding: 14px 28px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: #fff;
    color: #111;
    transition: transform 0.2s, background 0.2s;
}
#searchButton:hover {
    transform: scale(1.05);
    background: #e50914;
    color: #fff;
}

/* ================= GRID ================= */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
    padding: 0 20px 40px;
}

/* ================= CARDS ================= */
.movie-card, .cont-card {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    cursor: pointer;
    background: #111;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.movie-card:hover, .cont-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0,0,0,0.5);
}
.movie-card img, .cont-card img {
    width: 100%;
    height: 330px;
    object-fit: cover;
    border-radius: 16px;
    transition: transform 0.35s ease;
}
.cont-card img { height: 250px; }
.movie-card:hover img, .cont-card:hover img { transform: scale(1.07); }

/* ================= PLAY OVERLAY ================= */
.overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 52px;
    color: rgba(255,255,255,0.9);
    background: rgba(0,0,0,0.45);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    border-radius: 16px;
}
.movie-card:hover .overlay,
.cont-card:hover .overlay {
    opacity: 1;
    transform: scale(1.1);
}
.overlay i { transition: transform 0.2s ease; }
.overlay:hover i { transform: scale(1.2); }

/* ================= CARD TITLES ================= */
.movie-card .title {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 12px 10px;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    letter-spacing: 0.5px;
}

/* ================= REMOVE BUTTON ================= */
.cont-card .remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: #f44336;
    border: none;
    border-radius: 14px;
    padding: 6px 10px;
    color: #fff;
    cursor: pointer;
    display: none;
}
.cont-card:hover .remove-btn { display: block; }

/* ================= LOAD MORE ================= */
#loadMoreBtn {
    display: block;
    margin: 20px auto 50px;
    padding: 14px 32px;
    font-size: 16px;
    border-radius: 30px;
    border: none;
    background: #fff;
    color: #000;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
}
#loadMoreBtn:hover {
    transform: scale(1.05);
    background: #e50914;
    color: #fff;
}

/* ================= DETAIL SCREEN ================= */
#detailScreen {
    display: none;
    position: fixed;
    inset: 0;
    background: #111;
    z-index: 9999;
    overflow-y: auto;
    padding: 40px 20px;
    animation: fadeIn 0.4s ease;
}
#detailScreen .closeDetail {
    position: fixed;
    top: 20px;
    right: 20px;
    font-size: 36px;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    z-index: 10001;
}
#detailScreen .banner img {
    width: 100%;
    max-height: 60vh;
    object-fit: cover;
    border-radius: 20px;
}
#detailScreen .info {
    max-width: 900px;
    margin: 25px auto;
    text-align: center;
}
#detailScreen h2 { font-size: 36px; margin-bottom: 10px; }
#detailScreen .rating { color: #ffd700; margin-bottom: 15px; }
#detailScreen p { font-size: 18px; line-height: 1.6; color: #ccc; }

/* ================= DETAIL BUTTONS ================= */
#detailScreen .buttons {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin-top: 25px;
    flex-wrap: wrap;
}
#detailScreen .buttons button {
    padding: 15px 30px;
    font-size: 18px;
    border-radius: 28px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s, box-shadow 0.2s;
}
#watchBtn {
    background: #e50914;
    color: #fff;
}
#watchBtn:hover { 
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
}
#trailerBtn {
    background: rgba(255,255,255,0.12);
    color: #fff;
}
#trailerBtn:hover { 
    background: rgba(255,255,255,0.25);
    transform: scale(1.05);
}

/* ================= PLAYER ================= */
#playerContainer {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
}
#playerContainer iframe { width: 100%; height: 100%; border: none; }
#backBtn, #nextBtn {
    position: absolute;
    top: 20px;
    padding: 10px 18px;
    border-radius: 16px;
    background: rgba(0,0,0,0.85);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 18px;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 8px;
}
#backBtn { right: 20px; }
#nextBtn { left: 20px; }
#backBtn:hover, #nextBtn:hover { background: #000; transform: scale(1.05); }

/* ================= CONTINUE WATCHING ================= */
#continueWatchingSection {
    display: none;
    margin: 25px 0;
}
#continueWatchingSection h2 {
    margin-left: 20px;
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    gap: 10px;
}
#continueWatching {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
    gap: 18px;
    padding: 0 20px;
}

/* ================= TOAST ================= */
#toastContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10002;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.toast {
    padding: 14px 22px;
    background: rgba(0,0,0,0.8);
    border-radius: 14px;
    font-size: 14px;
    letter-spacing: 0.5px;
}

/* ================= ANIMATIONS ================= */
@keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

/* ================= RESPONSIVE ================= */
@media (max-width: 1000px) { .movie-card img { height: 300px; } }
@media (max-width: 768px) { 
    .movie-card img { height: 260px; }
    #detailScreen h2 { font-size: 28px; }
    #detailScreen .buttons button { font-size: 16px; padding: 12px 26px; }
}
@media (max-width: 480px) {
    #searchInput { flex: 1 1 150px; font-size: 14px; padding: 12px 16px; }
    .grid { gap: 14px; }
    #continueWatching { grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); }
    #detailScreen h2 { font-size: 24px; }
}
</style>
</head>
<body>

<h1>üé¨ Popcorn Hub üçø Beta</h1>
<h3>Mathematically proven to make your day better :)</h3>
<h3>How's your day going?</h3>

<div class="search-container">
  <input id="searchInput" placeholder=" What are you gonna watch today? üçø" />
  <button id="searchButton"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
</div>

<div id="continueWatchingSection">
  <h2 style="margin-left:18px"><i class="fa-solid fa-play-circle"></i> Continue Watching</h2>
  <div id="continueWatching"></div>
</div>

<div id="trending" class="grid"></div>
<button id="loadMoreBtn">load more results</button>

<!-- Detail screen -->
<div id="detailScreen">
  <button class="closeDetail"><i class="fa-solid fa-xmark"></i></button>
  <div class="banner"><img id="detailImage" src="" alt=""></div>
  <div class="info">
    <h2 id="detailTitle"></h2>
    <div class="rating" id="detailRating"></div>
    <p id="detailOverview"></p>

    <div class="detail-controls">
      <button id="watchBtn"><i class="fa-solid fa-play"></i> Watch Now</button>
      <button id="pickBtn" style="display:none;"><i class="fa-solid fa-list"></i> Pick Episode</button>
      <button id="trailerBtn"><i class="fa-solid fa-film"></i> Trailer</button>
    </div>
  </div>
</div>

<!-- Player -->
<div id="playerContainer">
  <button id="nextBtn"><i class="fa-solid fa-forward"></i> Next Episode</button>
  <button id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back</button>
  <iframe id="contentPlayer" sandbox=""></iframe>
</div>

<!-- Episode picker modal -->
<div id="episodePicker">
  <div class="picker-card">
    <div class="picker-head">
      <h3 id="pickerTitle">Pick Season & Episode</h3>
      <div>
        <select id="seasonSelect"></select>
      </div>
    </div>

    <div id="episodeRow" class="episode-row" aria-live="polite"></div>

    <div class="picker-actions">
      <button id="pickerCancel">Cancel</button>
      <button id="pickerPlay">Play Episode</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<script>
<script>
// ================= TMDB & CONFIG =================
const API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxMDBiMDIzOWQzNGY5YzI0Yjc2MzM5Mjg2YjNlOWNiMSIsIm5iZiI6MTc0ODUwMzgzMS43NjMsInN1YiI6IjY4MzgwZDE3MDc5YTQyZTI4NzAzODYyMyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.ykvYVrw8wjBdjkeb-71y1n1Z8ng3xE5ciodJ6FZgrNw';
const ITEMS_PER_PAGE = 15;
let trendingData = [], currentIndex = 0;
let currentTV = null, currentSeason = null, currentEpisode = null;

// ================= Helpers =================
const $ = id => document.getElementById(id);
function toast(msg, ms=2800){
  const container = $('toastContainer');
  if(!container) return console.warn('No toast container');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  container.appendChild(t);
  setTimeout(()=> { if(container.contains(t)) t.remove(); }, ms);
}
async function safeJson(resp){
  try{ if(!resp || !resp.ok) return null; return await resp.json(); }
  catch(e){ console.error('JSON parse failed', e); return null; }
}
function mediaType(item){ return item._media_type || (item.title ? 'movie' : 'tv'); }
const movieEmbed = id => `https://fmovies4u.com/embed/tmdb-movie-${id}`;
const tvEmbed = (id,s,e) => `https://fmovies4u.com/embed/tmdb-tv-${id}/${s}/${e}`;

// helper to get picker elements lazily (avoid nulls)
function pickerElements(){
  return {
    modal: $('episodePicker'),
    seasonSelect: $('seasonSelect'),
    episodeRow: $('episodeRow'),
    pickerTitle: $('pickerTitle'),
    pickerCancel: $('pickerCancel'),
    pickerPlay: $('pickerPlay')
  };
}

// ================= Trending / Cards =================
async function loadTrending(){
  try {
    const [mResp, tResp] = await Promise.all([
      fetch('https://api.themoviedb.org/3/trending/movie/week', { headers: { Authorization: `Bearer ${API_KEY}` } }),
      fetch('https://api.themoviedb.org/3/trending/tv/week',    { headers: { Authorization: `Bearer ${API_KEY}` } })
    ]);
    const m = await safeJson(mResp) || { results: [] };
    const t = await safeJson(tResp) || { results: [] };
    trendingData = [
      ...(m.results||[]).map(x=>({...x, _media_type: 'movie'})),
      ...(t.results||[]).map(x=>({...x, _media_type: 'tv'}))
    ];
    trendingData.sort((a,b)=> (b.popularity||0) - (a.popularity||0));
    currentIndex = 0;
    const grid = $('trending'); if(grid) grid.innerHTML = '';
    loadMore();
  } catch (e) {
    console.error('loadTrending', e);
    toast('Failed to load trending');
  }
}

function createCard(item){
  // ensure _media_type present
  if(!item._media_type) item._media_type = mediaType(item);
  const d = document.createElement('div');
  d.className = 'movie-card';
  d.dataset.id = item.id;
  d.dataset.type = item._media_type;
  const img = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
  // include overlay for play icon (visible on hover via CSS)
  d.innerHTML = `
    <img src="${img}" alt="${(item.title || item.name || 'Untitled').replace(/"/g,'') }">
    <div class="title">${item.title || item.name || 'Untitled'}</div>
    <div class="overlay" aria-hidden="true"><i class="fa-solid fa-play"></i></div>
  `;
  // open details when clicking anywhere on the card
  d.addEventListener('click', (e) => {
    // If user clicked a control in the card in future, we can detect and ignore ‚Äî for now open detail
    openDetail(item);
  });
  return d;
}

function loadMore(){
  const grid = $('trending');
  if(!grid) return;
  if(!trendingData || trendingData.length === 0){
    grid.innerHTML = '<p style="padding:20px;color:#ccc">No results to display.</p>';
    const btn = $('loadMoreBtn'); if(btn) btn.style.display = 'none';
    return;
  }
  const items = trendingData.slice(currentIndex, currentIndex + ITEMS_PER_PAGE);
  items.forEach(i => grid.appendChild(createCard(i)));
  currentIndex += items.length;
  const btn = $('loadMoreBtn'); if(btn) btn.style.display = (currentIndex >= trendingData.length) ? 'none' : 'block';
}

// ================= Search =================
async function searchContent(){
  const q = ($('searchInput') && $('searchInput').value || '').trim();
  if(!q) return toast('Enter a search term');
  try {
    const [mResp, tResp] = await Promise.all([
      fetch(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(q)}&language=en-US`, { headers:{ Authorization:`Bearer ${API_KEY}` } }),
      fetch(`https://api.themoviedb.org/3/search/tv?query=${encodeURIComponent(q)}&language=en-US`, { headers:{ Authorization:`Bearer ${API_KEY}` } })
    ]);
    const md = await safeJson(mResp) || { results: [] };
    const td = await safeJson(tResp) || { results: [] };
    trendingData = [
      ...(md.results||[]).map(x=>({...x, _media_type:'movie'})),
      ...(td.results||[]).map(x=>({...x, _media_type:'tv'}))
    ];
    currentIndex = 0;
    $('trending').innerHTML = '';
    if(!trendingData.length){
      $('trending').innerHTML = '<p style="padding:18px;color:#ccc">No results</p>';
      const btn = $('loadMoreBtn'); if(btn) btn.style.display = 'none';
      return;
    }
    loadMore();
  } catch (e) {
    console.error('searchContent', e);
    toast('Search failed');
  }
}

// ================= Episode Picker =================
async function openEpisodePicker(tvId, preselect = null){
  const { modal, seasonSelect, episodeRow, pickerTitle, pickerCancel, pickerPlay } = pickerElements();
  if(!modal || !seasonSelect || !episodeRow) {
    toast('Picker not available');
    return null;
  }
  modal.style.display = 'flex';
  pickerTitle && (pickerTitle.textContent = 'Pick Season & Episode');
  seasonSelect.innerHTML = '';
  episodeRow.innerHTML = '';

  const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
  const tvData = await safeJson(tvResp);
  if(!tvData){ toast('Failed to load show info'); modal.style.display='none'; return null; }

  const seasons = (tvData.seasons || []).filter(s=>s.season_number>0);
  if(seasons.length === 0){
    seasonSelect.innerHTML = '<option value="1">Season 1</option>';
  } else {
    seasons.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.season_number;
      opt.textContent = `Season ${s.season_number}${s.name ? ' ‚Äî ' + s.name : ''}`;
      seasonSelect.appendChild(opt);
    });
  }

  async function loadFor(snum, highlightEp = null){
    episodeRow.innerHTML = '';
    const sResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${snum}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sData = await safeJson(sResp);
    const eps = sData?.episodes || [];
    if(!eps.length){
      episodeRow.innerHTML = '<div style="color:#aaa;padding:8px">No episodes</div>';
      return;
    }
    eps.forEach(ep => {
      const btn = document.createElement('button');
      btn.className = 'episode-btn';
      btn.dataset.ep = ep.episode_number;
      btn.innerHTML = `<div class="ep-num">E${ep.episode_number}</div><span class="ep-title" title="${(ep.name||'').replace(/"/g,'') }">${ep.name || 'Untitled'}</span>`;
      if(highlightEp && Number(highlightEp) === Number(ep.episode_number)){
        btn.classList.add('active','watched');
        setTimeout(()=> btn.scrollIntoView({behavior:'smooth', inline:'center'}), 60);
      }
      btn.onclick = () => {
        episodeRow.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      };
      episodeRow.appendChild(btn);
    });
  }

  // set default selection
  if(preselect && preselect.season){
    const opt = Array.from(seasonSelect.options).find(o => Number(o.value) === Number(preselect.season));
    if(opt) seasonSelect.value = opt.value;
  }
  // initial load
  await loadFor(seasonSelect.value, preselect?.episode);

  seasonSelect.onchange = async () => { await loadFor(seasonSelect.value, preselect?.episode); };

  return new Promise((resolve) => {
    const onCancel = () => { modal.style.display='none'; cleanup(); resolve(null); };
    const onPlay = () => {
      const active = episodeRow.querySelector('button.active');
      if(!active){ toast('Select an episode'); return; }
      const season = Number(seasonSelect.value), episode = Number(active.dataset.ep);
      modal.style.display='none';
      cleanup();
      resolve({ season, episode });
    };
    function cleanup(){
      if(pickerCancel) pickerCancel.removeEventListener('click', onCancel);
      if(pickerPlay) pickerPlay.removeEventListener('click', onPlay);
    }
    if(pickerCancel) pickerCancel.addEventListener('click', onCancel);
    if(pickerPlay) pickerPlay.addEventListener('click', onPlay);
  });
}

// ================= Detail / Watch logic =================
async function openDetail(item, progress=null){
  if(!item) return;
  if(!item._media_type) item._media_type = mediaType(item);
  const detail = $('detailScreen');
  if(!detail) return;
  detail.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  const backdropSrc = item.backdrop_path ? `https://image.tmdb.org/t/p/w780${item.backdrop_path}` : (item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '');
  const di = $('detailImage'); if(di) di.src = backdropSrc;
  const dt = $('detailTitle'); if(dt) dt.textContent = item.title || item.name || 'Untitled';
  const dover = $('detailOverview'); if(dover) dover.textContent = item.overview || 'No description';
  const dr = $('detailRating'); if(dr) dr.textContent = `‚≠ê ${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}`;

  // determine progress
  if(item._media_type === 'tv'){
    const saved = JSON.parse(localStorage.getItem('continueWatching') || '{}');
    const key = `${item.id}-tv`;
    if(progress && progress.season && progress.episode){
      currentTV = item.id; currentSeason = Number(progress.season); currentEpisode = Number(progress.episode);
    } else if(saved[key]){
      currentTV = item.id; currentSeason = Number(saved[key].season); currentEpisode = Number(saved[key].episode);
    } else { currentTV = currentSeason = currentEpisode = null; }
    const pickBtn = $('pickBtn'); if(pickBtn) pickBtn.style.display = 'inline-flex';
  } else {
    currentTV = currentSeason = currentEpisode = null;
    const pickBtn = $('pickBtn'); if(pickBtn) pickBtn.style.display = 'none';
  }

  const watchBtn = $('watchBtn');
  if(watchBtn){
    watchBtn.textContent = (item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode) ? `Resume S${currentSeason}¬∑E${currentEpisode}` : 'Watch Now';
    watchBtn.onclick = async () => {
      const iframe = $('contentPlayer');
      if(!iframe) return toast('Player unavailable');
      // secure sandbox: allow-same-origin + allow-scripts (no allow-popups)
      iframe.setAttribute('sandbox','allow-scripts allow-same-origin');
      iframe.setAttribute('referrerpolicy','no-referrer');
      if(item._media_type === 'movie'){
        iframe.src = movieEmbed(item.id);
        $('playerContainer') && ($('playerContainer').style.display = 'flex');
        $('nextBtn') && ($('nextBtn').style.display = 'none');
        saveContinue(item);
      } else {
        if(currentTV === item.id && currentSeason && currentEpisode){
          iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
          $('playerContainer') && ($('playerContainer').style.display = 'flex');
          $('nextBtn') && ($('nextBtn').style.display = 'flex');
          saveContinue(item);
        } else {
          const sel = await openEpisodePicker(item.id, null);
          if(!sel) return;
          currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
          iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
          $('playerContainer') && ($('playerContainer').style.display = 'flex');
          $('nextBtn') && ($('nextBtn').style.display = 'flex');
          saveContinue(item);
        }
      }
    };
  }

  const pickBtn = $('pickBtn');
  if(pickBtn){
    pickBtn.onclick = async () => {
      if(!item._media_type || item._media_type !== 'tv') return;
      const pre = (currentTV === item.id && currentSeason && currentEpisode) ? { season: currentSeason, episode: currentEpisode } : null;
      const sel = await openEpisodePicker(item.id, pre);
      if(!sel) return;
      currentTV = item.id; currentSeason = sel.season; currentEpisode = sel.episode;
      const iframe = $('contentPlayer'); if(!iframe) return;
      iframe.setAttribute('sandbox','allow-scripts allow-same-origin');
      iframe.setAttribute('referrerpolicy','no-referrer');
      iframe.src = tvEmbed(item.id, currentSeason, currentEpisode);
      $('playerContainer') && ($('playerContainer').style.display = 'flex');
      $('nextBtn') && ($('nextBtn').style.display = 'flex');
      saveContinue(item);
    };
  }

  const trailerBtn = $('trailerBtn');
  if(trailerBtn){
    trailerBtn.onclick = async () => {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
        const data = await safeJson(res);
        const trailer = (data?.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer');
        if(trailer) window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank', 'noopener,noreferrer');
        else toast('Trailer not available');
      } catch(e){ console.error('trailer', e); toast('Trailer fetch failed'); }
    };
  }

  // next button visibility
  if(item._media_type === 'tv' && currentTV === item.id && currentSeason && currentEpisode){
    checkNextEpisode(item.id, currentSeason, currentEpisode).catch(()=> { if($('nextBtn')) $('nextBtn').style.display = 'none'; });
  } else { if($('nextBtn')) $('nextBtn').style.display = 'none'; }
}

// ================= Continue watching =================
async function renderContinueWatching(){
  const section = $('continueWatchingSection'), container = $('continueWatching');
  if(!section || !container) return;
  container.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('continueWatching') || '{}');
  const keys = Object.keys(saved).sort((a,b)=>(saved[b].timestamp||0)-(saved[a].timestamp||0));
  if(!keys.length){ section.style.display = 'none'; return; }
  section.style.display = 'block';

  const promises = keys.map(k => {
    const s = saved[k];
    return fetch(`https://api.themoviedb.org/3/${s.type}/${s.id}`, { headers:{ Authorization:`Bearer ${API_KEY}` } })
      .then(r => safeJson(r))
      .then(data => ({ key: k, meta: s, data }))
      .catch(e => ({ key: k, meta: s, data: null }));
  });

  const results = await Promise.all(promises);
  results.forEach(res => {
    const k = res.key, s = res.meta, data = res.data;
    const card = document.createElement('div'); card.className = 'cont-card'; card.style.position='relative';
    if(!data){
      card.innerHTML = `<div style="background:#333;height:240px;"></div>`;
      container.appendChild(card); return;
    }
    data._media_type = s.type;
    const img = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : 'https://via.placeholder.com/500x750';
    const label = (s.type === 'tv' && s.season && s.episode) ? `S${s.season}¬∑E${s.episode}` : '';
    card.innerHTML = `
      <img src="${img}" alt="">
      <div style="position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,0.6);padding:4px 8px;border-radius:6px;font-size:12px;color:#fff;">${label}</div>
      <div style="position:absolute;right:6px;top:6px;display:flex;gap:6px;">
        <button class="edit-btn" style="background:#222;color:#fff;border-radius:6px;padding:6px;">‚úé</button>
        <button class="rm-btn" style="background:#f44336;color:#fff;border-radius:6px;padding:6px;">üóë</button>
      </div>`;
    // open detail on click (avoid clicks on controls)
    card.addEventListener('click', (e) => { if(e.target.closest('.edit-btn') || e.target.closest('.rm-btn')) return; openDetail(data, { season: s.season, episode: s.episode }); });

    const editBtn = card.querySelector('.edit-btn');
    if(editBtn) editBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const sel = await openEpisodePicker(s.id, { season: s.season, episode: s.episode });
      if(!sel) return;
      const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
      store[k].season = sel.season; store[k].episode = sel.episode; store[k].timestamp = Date.now();
      localStorage.setItem('continueWatching', JSON.stringify(store));
      toast('Updated continue watching');
      renderContinueWatching();
    });

    const rmBtn = card.querySelector('.rm-btn');
    if(rmBtn) rmBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
      delete store[k];
      localStorage.setItem('continueWatching', JSON.stringify(store));
      renderContinueWatching();
    });

    container.appendChild(card);
  });
}

// ================= Save continue helper =================
function saveContinue(item){
  const type = item._media_type || mediaType(item);
  const saved = JSON.parse(localStorage.getItem('continueWatching') || '{}');
  saved[`${item.id}-${type}`] = {
    id: item.id,
    type,
    season: (type === 'tv') ? Number(currentSeason) : null,
    episode: (type === 'tv') ? Number(currentEpisode) : null,
    timestamp: Date.now()
  };
  localStorage.setItem('continueWatching', JSON.stringify(saved));
  renderContinueWatching();
}

// ================= Next episode logic =================
async function checkNextEpisode(tvId, season, episode){
  try {
    season = Number(season); episode = Number(episode);
    const sResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${season}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sData = await safeJson(sResp);
    const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const tvData = await safeJson(tvResp);
    const epsInSeason = sData?.episodes?.length || 0;
    let hasNext = (episode < epsInSeason);
    if(!hasNext){
      const maxSeason = tvData?.number_of_seasons || (tvData.seasons ? Math.max(...tvData.seasons.map(s=>s.season_number||0)) : 0);
      for(let s = season + 1; s <= maxSeason; s++){
        try{
          const resp = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${s}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
          const sData2 = await safeJson(resp);
          if(sData2 && (sData2.episodes||[]).length > 0){ hasNext = true; break; }
        }catch(e){ continue; }
      }
    }
    if($('nextBtn')) $('nextBtn').style.display = 'flex';
    return hasNext;
  } catch(e) {
    console.error('checkNextEpisode', e);
    if($('nextBtn')) $('nextBtn').style.display = 'none';
    return false;
  }
}

$('nextBtn') && $('nextBtn').addEventListener('click', async ()=>{
  try{
    if(!currentTV) return;
    currentSeason = Number(currentSeason); currentEpisode = Number(currentEpisode);
    const sResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${currentSeason}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const sData = await safeJson(sResp);
    const total = sData?.episodes?.length || 0;
    currentEpisode++;
    if(currentEpisode > total){
      // try next seasons
      const tvResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
      const tvData = await safeJson(tvResp);
      let found = false;
      const maxSeason = tvData?.number_of_seasons || 0;
      for(let s = currentSeason + 1; s <= maxSeason; s++){
        try{
          const nResp = await fetch(`https://api.themoviedb.org/3/tv/${currentTV}/season/${s}`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
          const nData = await safeJson(nResp);
          if(nData && (nData.episodes||[]).length > 0){ currentSeason = s; currentEpisode = 1; found = true; break; }
        }catch(e){ continue; }
      }
      if(!found){ currentSeason = 1; currentEpisode = 1; }
    }
    const iframe = $('contentPlayer');
    if(iframe){
      iframe.setAttribute('sandbox','allow-scripts allow-same-origin');
      iframe.src = tvEmbed(currentTV, currentSeason, currentEpisode);
    }
    const store = JSON.parse(localStorage.getItem('continueWatching') || '{}');
    store[`${currentTV}-tv`] = { id: currentTV, type: 'tv', season: currentSeason, episode: currentEpisode, timestamp: Date.now() };
    localStorage.setItem('continueWatching', JSON.stringify(store));
    renderContinueWatching();
    await checkNextEpisode(currentTV, currentSeason, currentEpisode);
  } catch(e){
    console.error('nextBtn click', e);
    toast('Failed to load next');
  }
});

// ================= Trailer helper =================
async function openTrailer(item){
  try{
    const res = await fetch(`https://api.themoviedb.org/3/${item._media_type}/${item.id}/videos`, { headers:{ Authorization:`Bearer ${API_KEY}` } });
    const d = await safeJson(res);
    const t = (d?.results||[]).find(v => v.site === 'YouTube' && v.type === 'Trailer');
    if(t) window.open(`https://www.youtube.com/watch?v=${t.key}`, '_blank', 'noopener,noreferrer');
    else toast('Trailer not available');
  } catch(e){ console.error('openTrailer', e); toast('Trailer failed'); }
}

// ================= Close / Back UI =================
$('backBtn') && $('backBtn').addEventListener('click', ()=>{
  const player = $('playerContainer'); if(player) player.style.display='none';
  const iframe = $('contentPlayer'); if(iframe) iframe.src = '';
  currentTV = currentSeason = currentEpisode = null;
  if($('nextBtn')) $('nextBtn').style.display = 'none';
});
document.querySelector('.closeDetail') && document.querySelector('.closeDetail').addEventListener('click', ()=>{
  const det = $('detailScreen'); if(det) det.style.display = 'none';
  document.body.style.overflow = 'auto';
});

// ================= Init =================
window.addEventListener('DOMContentLoaded', ()=>{
  const loadMoreBtn = $('loadMoreBtn'); if(loadMoreBtn) loadMoreBtn.addEventListener('click', loadMore);
  const searchBtn = $('searchButton'); if(searchBtn) searchBtn.addEventListener('click', searchContent);
  const searchInput = $('searchInput'); if(searchInput) searchInput.addEventListener('keydown', e => { if(e.key === 'Enter') searchContent(); });
  // Ensure episode picker controls exist - wire cancel/play if they are present (they are wired in openEpisodePicker)
  loadTrending();
  renderContinueWatching();
});
</script>
</body>
</html>